                    editButton.addEventListener('click', () => startEditShiftConfig(config));
                    actionCell.appendChild(editButton);
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'button danger subtle';
                    deleteButton.type = 'button';
                    deleteButton.textContent = '削除';
                    deleteButton.style.marginLeft = '8px';
                    deleteButton.addEventListener('click', () => deleteShiftConfig(config));
                    actionCell.appendChild(deleteButton);
                    row.appendChild(actionCell);
                    tbody.appendChild(row);
                });
        }

        function updateDataStats(stats) {
            const elEmployees = document.getElementById('data-total-employees');
            const elAssignments = document.getElementById('data-total-assignments');
            const elUpdated = document.getElementById('data-last-updated');
            const list = document.getElementById('data-monthly-stats');
            if (!elEmployees || !elAssignments || !elUpdated || !list) {
                return;
            }
            elEmployees.textContent = stats.totalEmployees ?? 0;
            elAssignments.textContent = stats.totalAssignments ?? 0;
            elUpdated.textContent = stats.lastUpdated ? formatDateTime(stats.lastUpdated) : '-';
            list.innerHTML = '';
            if (stats.monthlyStats && Object.keys(stats.monthlyStats).length > 0) {
                Object.entries(stats.monthlyStats)
                    .sort((a, b) => b[0].localeCompare(a[0]))
                    .slice(0, 6)
                    .forEach(([month, count]) => {
                        const li = document.createElement('li');
                        li.textContent = `${month}: ${count}`;
                        list.appendChild(li);
                    });
            } else {
                const li = document.createElement('li');
                li.className = 'muted';
                li.textContent = 'データがありません';
                list.appendChild(li);
            }
        }

        async function handleCreateEmployee(event) {
            event.preventDefault();
            const name = document.getElementById('employee-name').value.trim();
            const role = document.getElementById('employee-role').value.trim();
            if (!name) {
                setMessage('employee-message', '氏名を入力してください。', 'error');
                return;
            }
            try {
                await callApi('/api/employees', {
                    method: 'POST',
                    body: { name, role }
                });
                document.getElementById('employee-form').reset();
                setMessage('employee-message', '従業員を追加しました。', 'success');
                await loadEmployees();
                await loadDataStats();
            } catch (error) {
                setMessage('employee-message', error.message || '従業員の追加に失敗しました。', 'error');
            }
        }

        async function deleteEmployee(employee) {
            if (!confirm(`${employee.name} さんを削除しますか？`)) {
                return;
            }
            try {
                await callApi(`/api/employees/${employee.id}`, { method: 'DELETE' });
                setMessage('employee-message', '従業員を削除しました。', 'success');
                await loadEmployees();
                await loadDataStats();
                await loadSchedule();
                await loadStatistics();
            } catch (error) {
                setMessage('employee-message', error.message || '従業員の削除に失敗しました。', 'error');
            }
        }

        async function deleteShiftConfig(config) {
            if (!confirm(`「${config.name}」を削除しますか？`)) {
                return;
            }
            try {
                await callApi(`/api/config/shift/${config.id}`, { method: 'DELETE' }, { expectSuccess: false });
                setMessage('shift-config-message', 'シフト設定を削除しました。', 'success');
                await loadShiftConfigs();
                // small delay to wait for async generation to persist
                await new Promise(r => setTimeout(r, 1500));
                await loadSchedule();
                await loadStatistics();
            } catch (error) {
                setMessage('shift-config-message', error.message || 'シフト設定の削除に失敗しました。', 'error');
            }
        }

        let editingConfigId = null;

        function dayOfWeekLabel(dow) {
            const map = { MONDAY: '月', TUESDAY: '火', WEDNESDAY: '水', THURSDAY: '木', FRIDAY: '金', SATURDAY: '土', SUNDAY: '日' };
            return map[dow] || dow;
        }

        function startEditShiftConfig(config) {
            editingConfigId = config.id;
            document.getElementById('config-name').value = config.name || '';
            document.getElementById('config-start').value = (config.startTime || '').slice(0,5);
            document.getElementById('config-end').value = (config.endTime || '').slice(0,5);
            document.getElementById('config-required').value = config.requiredEmployees ?? 1;
            // 対象(平日/週末)は廃止: weekend の編集項目は無し
            // multiple days
            const boxes = document.querySelectorAll('#config-days input[type="checkbox"]');
            boxes.forEach(b => b.checked = (config.days || []).includes(b.value));
            const hol = document.getElementById('config-holiday');
            if (hol) hol.checked = !!config.holiday;
            const submitBtn = document.getElementById('config-submit');
            if (submitBtn) submitBtn.textContent = '設定を更新';
            const cancelBtn = document.getElementById('config-cancel');
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
            setMessage('shift-config-message', '編集モードです。更新後に「設定を更新」を押してください。', 'info');
        }

        function cancelEditShiftConfig() {
            editingConfigId = null;
            document.getElementById('shift-config-form').reset();
            document.getElementById('config-required').value = 4;
            const boxes = document.querySelectorAll('#config-days input[type="checkbox"]');
            boxes.forEach(b => b.checked = false);
            const submitBtn2 = document.getElementById('config-submit');
            if (submitBtn2) submitBtn2.textContent = '設定を追加';
            const cancelBtn = document.getElementById('config-cancel');
            if (cancelBtn) cancelBtn.style.display = 'none';
            setMessage('shift-config-message', '', 'info');
        }

        const cancelBtnInit = document.getElementById('config-cancel');
        if (cancelBtnInit) cancelBtnInit.addEventListener('click', cancelEditShiftConfig);

        async function handleCreateShiftConfig(event) {
            event.preventDefault();
            const payload = {
                name: document.getElementById('config-name').value.trim(),
                startTime: document.getElementById('config-start').value,
                endTime: document.getElementById('config-end').value,
                requiredEmployees: Number(document.getElementById('config-required').value || 0),
                // 対象(平日/週末)は廃止（送信しない）
                dayOfWeek: null,
                holiday: document.getElementById('config-holiday')?.checked || false,
                days: Array.from(document.querySelectorAll('#config-days input[type="checkbox"]:checked')).map(b => b.value)
            };
            if (!payload.name || !payload.startTime || !payload.endTime || payload.requiredEmployees <= 0) {
                setMessage('shift-config-message', 'すべての項目を正しく入力してください。', 'error');
                return;
            }
            try {
                if (editingConfigId) {
                    await callApi(`/api/config/shift/${editingConfigId}`, { method: 'PUT', body: payload }, { expectSuccess: false });
                    setMessage('shift-config-message', 'シフト設定を更新しました。', 'success');
                } else {
                    await callApi('/api/config/shift', { method: 'POST', body: payload }, { expectSuccess: false });
                    setMessage('shift-config-message', 'シフト設定を追加しました。', 'success');
                }
                cancelEditShiftConfig();
                await loadShiftConfigs();
            } catch (error) {
                setMessage('shift-config-message', error.message || 'シフト設定の追加/更新に失敗しました。', 'error');
            }
        }

        async function toggleShiftConfig(config) {
            try {
                const updated = await callApi(`/api/config/shift/${config.id}/toggle`, { method: 'POST' }, { expectSuccess: false });
                setMessage('shift-config-message', `「${updated.name}」を${updated.active ? '有効化' : '停止'}しました。`, 'success');
                await loadShiftConfigs();
                await loadSchedule();
                await loadStatistics();
            } catch (error) {
                setMessage('shift-config-message', error.message || 'シフト設定の更新に失敗しました。', 'error');
            }
        }

        async function downloadFile(url, suggestedName) {
            try {
                const response = await fetch(url, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const blob = await response.blob();
                const disposition = response.headers.get('content-disposition');
                const filename = getFilenameFromDisposition(disposition) || suggestedName;
                const link = document.createElement('a');
                const href = URL.createObjectURL(blob);
                link.href = href;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(href);
                setMessage('data-message', `${filename} をダウンロードしました。`, 'success');
            } catch (error) {
                setMessage('data-message', error.message || 'ダウンロードに失敗しました。', 'error');
            }
        }

        async function loadUserInfo() {
            try {
                const data = await callApi('/api/auth/me', {}, { expectSuccess: false });
                if (!data || data.success === false) {
                    throw new Error('認証が必要です');
                }
                const info = document.getElementById('user-info');
                info.textContent = `ようこそ、${data.username} さん (${data.role})`;
            } catch (error) {
                window.location.href = '/login';
            }
        }

        async function logout() {
            try {
                await callApi('/api/auth/logout', { method: 'POST' }, { expectSuccess: false });
            } finally {
                window.location.href = '/login?logout';
            }
        }

        window.logout = logout;

        async function callApi(url, options = {}, config = {}) {
            const expectSuccess = config.expectSuccess !== false;
            const timeoutMs = Number(config.timeoutMs ?? 15000);
            const retries = Number(config.retries ?? 1);
            const requestOptions = buildRequestOptions(options);
            let lastError = null;
            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const response = await fetch(url, { ...requestOptions, signal: controller.signal });
                    clearTimeout(id);
                    const contentType = response.headers.get('content-type') || '';
                    let data = null;
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        const text = await response.text();
                        if (text) {
                            try { data = JSON.parse(text); } catch { data = { message: text }; }
                        }
                    }
                    if (!response.ok) {
                        const message = data?.message || `HTTP ${response.status}`;
                        throw new Error(message);
                    }
                    if (expectSuccess && data && data.success === false) {
                        throw new Error(data.message || 'リクエストに失敗しました');
                    }
                    return data;
                } catch (err) {
                    lastError = err;
                    clearTimeout(id);
                    if (attempt < retries) {
                        await new Promise(r => setTimeout(r, 500 * (attempt + 1)));
                        continue;
                    }
                    throw err;
                }
            }
            throw lastError ?? new Error('Unknown error');
        }

        function buildRequestOptions(options = {}) {
            const requestOptions = {
                credentials: 'include',
                ...options
            };
            requestOptions.headers = {
                'Content-Type': 'application/json',
                ...(options.headers || {})
            };
            if (requestOptions.body && typeof requestOptions.body !== 'string') {
                requestOptions.body = JSON.stringify(requestOptions.body);
            }
            return requestOptions;
        }

        function setMessage(id, text, type = 'info') {
            const element = document.getElementById(id);
            if (!element) {
                return;
            }
            if (!text) {
                element.textContent = '';
                element.style.display = 'none';
                element.className = 'message';
                return;
            }
            element.textContent = text;
            element.style.display = 'block';
            element.className = `message ${type}`;
        }

        function formatDateLabel(dateString) {
            const date = new Date(`${dateString}T00:00:00`);
            if (Number.isNaN(date.getTime())) {
                return dateString;
            }
            return `${date.getMonth() + 1}月${date.getDate()}日`;
        }

        function getDayLabel(dateString) {
            const date = new Date(`${dateString}T00:00:00`);
            if (Number.isNaN(date.getTime())) {
                return '';
            }
            const labels = ['日', '月', '火', '水', '木', '金', '土'];
            return labels[date.getDay()];
        }

        

        function formatTimeRange(start, end) {
            const startText = start ? start.slice(0, 5) : '';
            const endText = end ? end.slice(0, 5) : '';
            if (!startText || !endText) {
                return '-';
            }
            return `${startText}〜${endText}`;
        }

        function formatDateTime(value) {
            if (!value) {
                return '-';
            }
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        function getFilenameFromDisposition(disposition) {
            if (!disposition) {
                return null;
            }
            const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/);
            if (utfMatch && utfMatch[1]) {
                return decodeURIComponent(utfMatch[1]);
            }
            const simpleMatch = disposition.match(/filename="?([^";]+)"?/);
            return simpleMatch ? simpleMatch[1] : null;
        }
    </script>
    
    </div>
      <span style="display:inline-block; background:#2563eb; color:#fff; padding:12px 16px; border-radius:999px; box-shadow:0 8px 16px rgba(0,0,0,0.15); font-weight:600;">管理アクション</span>
    </a>
    <!-- Quick link: Management Actions (fallback) -->
    <a href="/admin-actions" style="position:fixed; right:16px; top:16px; z-index:9999; text-decoration:none;">
      <span style="display:inline-block; background:#2563eb; color:#fff; padding:8px 12px; border-radius:999px; box-shadow:0 6px 12px rgba(0,0,0,0.12); font-weight:600;">管理アクション</span>
    </a>
</body>
</html>
<script>
// Override: make delete flow resilient (avoid reporting failure when refresh fails)
if (typeof deleteShiftConfig === 'function') {
  const __orig_deleteShiftConfig = deleteShiftConfig;
}
function deleteShiftConfig(config) {
  if (!confirm(`「${config.name}」を削除しますか？`)) {
    return;
  }
  (async () => {
    try {
      await callApi(`/api/config/shift/${config.id}`, { method: 'DELETE' }, { expectSuccess: false });
      setMessage('shift-config-message', 'シフト設定を削除しました', 'success');
    } catch (error) {
      setMessage('shift-config-message', error.message || 'シフト設定の削除に失敗しました', 'error');
      return;
    }
    try { await loadShiftConfigs(); } catch (e) {}
    try { await loadSchedule(); } catch (e) {}
    try { await loadStatistics(); } catch (e) {}
  })();
}
</script>
                <div class="stat-subsection">
                    <h3>従業員の勤務/休日日数</h3>
                    <div id="employee-days" class="table-wrapper"></div>
                </div>






