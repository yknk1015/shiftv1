<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ルール管理</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin: 0; background:#f6f7fb; color:#0f172a; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; }
    .tabs { display:flex; gap:8px; border-bottom:1px solid #e2e8f0; }
    .tab { padding:10px 14px; cursor:pointer; border:1px solid #e2e8f0; border-bottom:none; border-radius:8px 8px 0 0; background:#fff; }
    .tab.active { background:#eef2ff; border-color:#c7d2fe; }
    .panel { background:#fff; border:1px solid #e2e8f0; border-radius:0 8px 8px 8px; padding:16px; }
    .row { display:flex; gap:16px; align-items:center; margin:10px 0; }
    label { min-width: 180px; color:#334155; }
    input[type="text"], input[type="date"], select { padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; min-width:220px; }
    .switch { display:inline-flex; align-items:center; gap:10px; }
    button { padding:8px 12px; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; }
    button.secondary { background:#64748b; }
    .note { color:#475569; font-size:13px; }
    .msg { margin-top:8px; font-size:13px; }
    .msg.ok { color:#14532d; }
    .msg.err { color:#7f1d1d; }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', init);
    async function init(){
      sel('tab-free').addEventListener('click', ()=>activate('free'));
      sel('tab-pattern').addEventListener('click', ()=>activate('pattern'));
      activate('free');
      await loadFree();
      await loadEmployees();
    }
    function sel(id){ return document.getElementById(id); }
    function activate(name){
      ['free','pattern'].forEach(n=>{
        sel('tab-'+n).classList.toggle('active', n===name);
        sel('panel-'+n).style.display = n===name? 'block':'none';
      });
    }
    async function loadFree(){
      try{
        const res = await fetch('/api/config/free-placeholders');
        const js = await res.json();
        if(js.success){
          sel('onlyWeekdays').checked = !!js.data.onlyWeekdays;
          sel('skipHolidays').checked = !!js.data.skipHolidays;
        }
      }catch(e){ console.warn(e); }
    }
    async function saveFree(){
      try{
        const body = { onlyWeekdays: sel('onlyWeekdays').checked, skipHolidays: sel('skipHolidays').checked };
        const res = await fetch('/api/config/free-placeholders', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        const js = await res.json();
        sel('msg-free').textContent = js.success? '保存しました' : '保存に失敗しました';
        sel('msg-free').className = 'msg ' + (js.success? 'ok':'err');
      }catch(e){ sel('msg-free').textContent='通信エラー'; sel('msg-free').className='msg err'; }
    }
    async function loadEmployees(){
      try{
        const res = await fetch('/api/employees');
        const js = await res.json();
        if(js.success){
          const s = sel('emp'); s.innerHTML='';
          js.data.forEach(e=>{ const o=document.createElement('option'); o.value=e.id; o.textContent=e.name; s.appendChild(o); });
          if(js.data.length){ sel('emp').value = js.data[0].id; await loadRule(); }
        }
      }catch(e){ console.warn(e); }
    }
    async function loadRule(){
      const id = sel('emp').value; if(!id) return;
      const res = await fetch(`/api/employees/${id}/rule`);
      const js = await res.json();
      if(js.success){
        const r = js.data;
        sel('pattern').value = r.workOffPattern || '';
        sel('anchor').value = r.patternAnchorDate || '';
        sel('strict').checked = !!r.patternStrict;
      }
    }
    async function saveRule(){
      const id = sel('emp').value; if(!id) return;
      const body = {
        workOffPattern: sel('pattern').value || null,
        patternAnchorDate: sel('anchor').value || null,
        patternStrict: sel('strict').checked
      };
      const res = await fetch(`/api/employees/${id}/rule`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const js = await res.json();
      sel('msg-pattern').textContent = js.success? '保存しました' : '保存に失敗しました';
      sel('msg-pattern').className = 'msg ' + (js.success? 'ok':'err');
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>ルール管理</h2>
      <a href="/dashboard"><button class="secondary">ダッシュボードへ戻る</button></a>
    </div>
    <div class="tabs">
      <div id="tab-free" class="tab active">FREE配置</div>
      <div id="tab-pattern" class="tab">勤務/休パターン</div>
    </div>
    <div class="panel" id="panel-free">
      <div class="row"><label>FREEは平日のみに配置</label><span class="switch"><input id="onlyWeekdays" type="checkbox"/> 平日限定</span></div>
      <div class="row"><label>祝日にFREEを配置しない</label><span class="switch"><input id="skipHolidays" type="checkbox"/> 祝日スキップ</span></div>
      <div class="row"><button onclick="saveFree()">保存</button><span id="msg-free" class="msg"></span></div>
      <p class="note">FREEは勤務扱いに含めません。余剰人員の活用（研修/有休促進など）用の枠です。</p>
    </div>
    <div class="panel" id="panel-pattern" style="display:none">
      <div class="row"><label>従業員</label><select id="emp" onchange="loadRule()"></select></div>
      <div class="row"><label>勤務/休パターン</label><input id="pattern" type="text" placeholder="例) 3W-1O-2W-1O"/></div>
      <div class="row"><label>アンカー日</label><input id="anchor" type="date"/></div>
      <div class="row"><label>厳格適用</label><span class="switch"><input id="strict" type="checkbox"/> OFF日は割当不可</span></div>
      <div class="row"><button onclick="saveRule()">保存</button><span id="msg-pattern" class="msg"></span></div>
      <p class="note">パターン例: "3W-1O-2W-1O" は「3勤1休→2勤1休」を繰り返します。厳格適用ONでOFF日を優先確保します。</p>
    </div>
  </div>
</body>
</html>

