<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>従業員マスタ</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; margin:0; background:#f5f7fb; color:#0f172a; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .back-link {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      color:#2563eb;
      text-decoration:none;
      margin-bottom:16px;
    }
    .back-link:hover { text-decoration:underline; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    input, select, button { padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px; }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #e2e8f0; text-align:left; }
    .muted { color:#64748b; font-size:12px; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .cols { grid-template-columns: 1fr; } }
    .pto-summary { display:flex; flex-wrap:wrap; gap:10px; margin-top:4px; }
    .pto-chip { background:#f1f5f9; border:1px solid #e2e8f0; border-radius:10px; padding:6px 12px; font-size:13px; display:flex; align-items:baseline; gap:6px; }
    .pto-chip strong { font-size:18px; color:#0f172a; }
    .pattern-builder { border:1px dashed #e2e8f0; border-radius:10px; padding:12px; background:#f8fafc; margin-top:8px; }
    .pattern-builder-row { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; align-items:flex-end; }
    .pattern-builder-row label { font-size:13px; color:#475569; display:flex; flex-direction:column; gap:4px; }
    .pattern-preview { font-size:13px; color:#334155; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <a class="back-link" href="/dashboard">← ダッシュボードへ戻る</a>
    <h2>従業員マスタ</h2>

    <!-- 統合ビュー（β）：マスタ/詳細タブ -->
    <div class="card" id="beta-integrated">
      <h3 style="margin:0 0 8px;">従業員マスタ</h3>
      <div class="muted" style="margin-bottom:8px;">左で従業員を選択し、右のタブで基本情報・スキル・勤務ルール・出勤可能時間・PTOをまとめて編集できます。</div>
      <style>
        .beta-layout { display:grid; grid-template-columns: 260px 1fr; gap:16px; }
        .beta-list { border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; background:#fff; }
        .beta-list-search { padding:8px; border-bottom:1px solid #e2e8f0; }
        .beta-list ul { list-style:none; margin:0; padding:0; max-height:360px; overflow:auto; }
        .beta-list li { padding:8px 10px; border-bottom:1px solid #f1f5f9; cursor:pointer; }
        .beta-list li.active { background:#eff6ff; font-weight:600; }
        .beta-list-actions { display:flex; gap:8px; margin-top:8px; }
        .beta-list-actions button { flex:1; }
        .beta-create { margin-top:10px; border:1px solid #e2e8f0; border-radius:8px; padding:10px; background:#f8fafc; display:grid; gap:8px; }
        .beta-create label { font-size:13px; color:#475569; display:flex; flex-direction:column; gap:4px; }
        .beta-create-buttons { display:flex; gap:8px; }
        .beta-tabs { display:flex; gap:8px; border-bottom:1px solid #e2e8f0; margin-bottom:12px; }
        .beta-tab { padding:8px 10px; cursor:pointer; border-radius:6px 6px 0 0; }
        .beta-tab.active { background:#eff6ff; font-weight:600; }
        .beta-panel { background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:12px; }
        .beta-row { display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
        .beta-row label { display:block; font-size:13px; color:#475569; }
        .beta-actions { display:flex; gap:8px; margin-top:8px; }
      </style>
      <div class="beta-layout">
        <div class="beta-list">
          <div class="beta-list-search">
            <input id="beta-q" type="text" placeholder="名前/役割で絞込" style="width:100%;"/>
            <div class="beta-list-actions">
              <button id="beta-refresh" type="button">再読み込み</button>
              <button id="beta-create-toggle" type="button">新規登録</button>
            </div>
            <div id="beta-create-form" class="beta-create" style="display:none;">
              <label>氏名<input type="text" id="beta-create-name" placeholder="例: 田中 太郎"/></label>
              <label>役割<input type="text" id="beta-create-role" placeholder="例: スタッフ"/></label>
              <label>表示順<input type="number" id="beta-create-order" min="0" step="1" placeholder="自動"/></label>
              <div class="beta-create-buttons">
                <button id="beta-create-save" type="button">追加</button>
                <button id="beta-create-cancel" type="button" style="background:#e2e8f0; color:#0f172a;">キャンセル</button>
              </div>
              <div class="muted" id="beta-create-msg"></div>
            </div>
          </div>
          <ul id="beta-emp-list"><li class="muted" style="padding:8px 10px;">読み込み中...</li></ul>
        </div>
        <div>
          <div class="beta-tabs">
            <div class="beta-tab active" data-tab="basic">基本情報</div>
            <div class="beta-tab" data-tab="skills">スキル</div>
            <div class="beta-tab" data-tab="rules">勤務ルール</div>
            <div class="beta-tab" data-tab="availability">出勤可能時間</div>
            <div class="beta-tab" data-tab="fixed">固定シフト</div>
            <div class="beta-tab" data-tab="pto">有給 (PTO)</div>
          </div>
          <div class="beta-panel">
            <div id="beta-panel-basic">
              <div class="beta-row">
                <label>氏名<br><input id="beta-name" type="text"/></label>
                <label>役割<br><input id="beta-role" type="text"/></label>
                <label>優先度(1-5)<br><input id="beta-priority" type="number" min="1" max="5" step="1"/></label>
                <label>表示順<br><input id="beta-order" type="number" min="0" step="1"/></label>
              </div>
              <div class="beta-actions">
                <button id="beta-save-basic">保存</button>
                <button id="beta-delete" style="background:#dc2626;" disabled>削除</button>
                <div id="beta-msg" class="muted"></div>
              </div>
            </div>
            <div id="beta-panel-skills" style="display:none;">
              <div class="beta-row" style="align-items:center;">
                <label style="flex:1;">検索<br><input id="beta-skill-q" type="text" placeholder="code/name 部分一致"/></label>
                <button id="beta-skill-search">検索</button>
                <button id="beta-skill-save">保存</button>
              </div>
              <div class="beta-row" style="align-items:flex-start; gap:24px; margin-top:8px;">
                <div style="flex:1; min-width:280px;">
                  <div class="muted">スキル一覧</div>
                  <div id="beta-skill-list" style="max-height:280px; overflow:auto; border:1px solid #e2e8f0; border-radius:8px; padding:8px;"></div>
                </div>
                <div style="flex:1; min-width:220px;">
                  <div class="muted">付与済み</div>
                  <ul id="beta-emp-skill-list" style="list-style:none; padding-left:0; margin:0; border:1px solid #e2e8f0; border-radius:8px; padding:8px; max-height:280px; overflow:auto;"></ul>
                </div>
              </div>
              <div id="beta-skill-msg" class="muted" style="margin-top:6px;"></div>
            </div>
            <div id="beta-panel-rules" style="display:none;">
              <div class="beta-row">
                <label>週最大時間<br><input type="number" id="beta-rule-weeklyMax"/></label>
                <label>日最大時間<br><input type="number" id="beta-rule-dailyMax"/></label>
                <label>連勤上限(日)<br><input type="number" id="beta-rule-maxConsec"/></label>
                <label>最低休息(時)<br><input type="number" id="beta-rule-minRest"/></label>
                <label>週休日数<br><input type="number" id="beta-rule-weeklyRest" min="0" max="7"/></label>
              </div>
              <div class="beta-row">
                <label><input type="checkbox" id="beta-rule-allowMulti"/> 1日に複数シフト可</label>
                <label><input type="checkbox" id="beta-rule-allowHoliday"/> 休日勤務可</label>
              </div>
              <div class="beta-row">
                <label>勤務/休パターン<br><input type="text" id="beta-rule-pattern" placeholder="例: 3W-1O-2W-1O"/></label>
                <label>アンカー日<br><input type="date" id="beta-rule-anchor"/></label>
                <label><input type="checkbox" id="beta-rule-strict"/> OFF日を厳格適用</label>
              </div>
              <p class="muted">パターンは「W=勤務、O=休み」で定義します。例: 3W-1O は「3勤1休」を繰返します。厳格適用ONでOFF日を先に確保します。</p>
              <div class="pattern-builder">
                <div class="muted">勤務日数と休日日数を入力して「パターンに追加」を押すと、上のパターン欄が自動更新されます。</div>
                <div class="pattern-builder-row">
                  <label>勤務日数<br><input type="number" id="pattern-work-days" min="0" value="3"/></label>
                  <label>休日日数<br><input type="number" id="pattern-off-days" min="0" value="1"/></label>
                  <button type="button" id="pattern-add">パターンに追加</button>
                  <button type="button" id="pattern-clear" style="background:#e2e8f0; color:#0f172a;">クリア</button>
                </div>
                <div class="pattern-preview" id="pattern-preview">現在のパターン: ー</div>
                <div class="muted" id="pattern-strict-hint" style="display:none; color:#b45309;">生成されたシフトに反映させるには「OFF日を厳格適用」をONにしてください。</div>
              </div>
              <div class="beta-actions">
                <button id="beta-rule-save">ルール保存</button>
                <div id="beta-rule-msg" class="muted"></div>
              </div>
            </div>
            <div id="beta-panel-availability" style="display:none;">
              <div class="beta-row">
                <label>曜日
                  <select id="beta-av-dow">
                    <option value="MONDAY">月曜日</option><option value="TUESDAY">火曜日</option><option value="WEDNESDAY">水曜日</option>
                    <option value="THURSDAY">木曜日</option><option value="FRIDAY">金曜日</option><option value="SATURDAY">土曜日</option><option value="SUNDAY">日曜日</option>
                  </select>
                </label>
                <label>開始<br><input type="time" id="beta-av-start" value="09:00"/></label>
                <label>終了<br><input type="time" id="beta-av-end" value="21:00"/></label>
                <button id="beta-av-add">追加</button>
                <button id="beta-av-clear">全クリア</button>
                <button id="beta-av-save">保存</button>
              </div>
              <table style="margin-top:8px; width:100%; border-collapse:collapse;">
                <thead><tr><th>曜日</th><th>開始</th><th>終了</th><th>操作</th></tr></thead>
                <tbody id="beta-av-tbody"></tbody>
              </table>
              <div class="muted" id="beta-av-msg" style="margin-top:6px;"></div>
            </div>
            <div id="beta-panel-fixed" style="display:none;">
              <table style="width:100%; border-collapse:collapse;">
                <thead><tr><th>曜日</th><th>有効</th><th>開始</th><th>終了</th><th>メモ</th></tr></thead>
                <tbody id="beta-fixed-tbody"></tbody>
              </table>
              <div class="muted" style="margin-top:6px;">祝日で「休日勤務不可」の従業員は自動的に除外されます。</div>
              <div class="beta-actions">
                <button id="beta-fixed-reset" type="button" class="ghost">リセット</button>
                <button id="beta-fixed-save" type="button">保存</button>
                <div id="beta-fixed-msg" class="muted"></div>
              </div>
            </div>
            <div id="beta-panel-pto" style="display:none;">
              <div class="beta-row">
                <div>残数: 
                  <span class="muted">付与</span> <span id="beta-pto-annual">0</span>
                  <span class="muted">繰越</span> <span id="beta-pto-carried">0</span>
                  <span class="muted">使用</span> <span id="beta-pto-used">0</span>
                  <span class="muted">残</span> <strong id="beta-pto-remaining">0</strong>
                </div>
              </div>
              <div class="beta-row">
                <label>有給付与(日)<br><input type="number" id="beta-pto-grantDays" min="1" value="1"/></label>
                <button id="beta-pto-grant">付与</button>
              </div>
              <div class="beta-row">
                <label>有給取得日<br><input type="date" id="beta-pto-date"/></label>
                <button id="beta-pto-request">登録</button>
              </div>
              <div class="muted" id="beta-pto-msg"></div>
            </div>
          </div>
        </div>
      </div>
<script src="/js/app.js"></script>
<script>
        let betaSelectedId = null;
        let betaEmployees = [];
        const betaFixedDays = [
          { key:'MONDAY', label:'月' },
          { key:'TUESDAY', label:'火' },
          { key:'WEDNESDAY', label:'水' },
          { key:'THURSDAY', label:'木' },
          { key:'FRIDAY', label:'金' },
          { key:'SATURDAY', label:'土' },
          { key:'SUNDAY', label:'日' }
        ];
        const betaDowMap = {
          MONDAY:'月曜日',
          TUESDAY:'火曜日',
          WEDNESDAY:'水曜日',
          THURSDAY:'木曜日',
          FRIDAY:'金曜日',
          SATURDAY:'土曜日',
          SUNDAY:'日曜日'
        };
        function betaDowLabel(code){
          return betaDowMap[code] || code || '';
        }
        let betaFixedState = [];
        let betaAvList = [];
        let betaPatternBlocks = [];
        let patternStrictTouched = false;
        async function betaFetch(url, opt={}){
          const res = await fetch(url, { credentials:'include', headers:{'Content-Type':'application/json'}, ...opt });
          const ct = res.headers.get('content-type')||''; const data = ct.includes('json') ? await res.json() : await res.text();
          if(!res.ok) throw new Error((data&&data.message)||('HTTP '+res.status));
          if(data && data.success===false) throw new Error(data.message||'処理に失敗しました');
          return data;
        }
        function betaSortEmployees(list){
          return [...(list||[])].sort((a,b)=>{
            const ao = a && a.displayOrder != null ? a.displayOrder : 0;
            const bo = b && b.displayOrder != null ? b.displayOrder : 0;
            if (ao !== bo) return ao - bo;
            const aid = a && a.id != null ? a.id : 0;
            const bid = b && b.id != null ? b.id : 0;
            return aid - bid;
          });
        }
        function betaNextDisplayOrder(){
          if (!Array.isArray(betaEmployees) || betaEmployees.length === 0) return 1;
          return betaEmployees.reduce((max, e)=>Math.max(max, e.displayOrder ?? 0), 0) + 1;
        }
        function betaRenderList(list = betaEmployees){
          const ul = document.getElementById('beta-emp-list');
          const q = (document.getElementById('beta-q').value||'').trim().toLowerCase();
          const filtered = betaSortEmployees(list).filter(e => {
            const n=(e.name||'').toLowerCase(); const r=(e.role||'').toLowerCase();
            return !q || n.includes(q) || r.includes(q);
          });
          if(filtered.length===0){
            const msg = list.length===0 ? '従業員が登録されていません' : '該当なし';
            ul.innerHTML = `<li class="muted" style="padding:8px 10px;">${msg}</li>`;
            return;
          }
          ul.innerHTML = '';
          filtered.forEach(e => {
            const li = document.createElement('li');
            const order = e.displayOrder ?? '';
            const roleText = e.role ? `(${e.role})` : '';
            li.innerHTML = `<span class="muted" style="min-width:32px;display:inline-block;">#${order}</span> ${e.id} ${e.name||''} ${roleText}`;
            li.dataset.empId = String(e.id ?? '');
            if (String(betaSelectedId)===String(e.id)) li.classList.add('active');
            li.addEventListener('click', ()=>{ betaLoadDetail(e.id); });
            ul.appendChild(li);
          });
        }
        function betaInitFixedState(){
          betaFixedState = betaFixedDays.map(day => ({
            dayOfWeek: day.key,
            label: day.label,
            active: false,
            startTime: '09:00',
            endTime: '18:00',
            note: ''
          }));
        }
        betaInitFixedState();
        function betaApplyFilter(){
            betaRenderList();
        }
        async function betaLoadList(preferId){
          try{
            const j = await betaFetch('/api/employees');
            betaEmployees = betaSortEmployees(j.data||[]);
            betaRenderList();
            const list = betaEmployees;
            const candidate = preferId ?? betaSelectedId ?? (list[0]?.id);
            if (candidate && list.some(e => String(e.id) === String(candidate))) {
              await betaLoadDetail(candidate);
            } else if (!list.length) {
              betaSelectedId = null;
              document.getElementById('beta-msg').textContent = '従業員を登録してください';
              const delBtn = document.getElementById('beta-delete'); if (delBtn) delBtn.disabled = true;
            } else {
              betaSelectedId = null;
              document.getElementById('beta-msg').textContent = '従業員を選択してください';
              const delBtn = document.getElementById('beta-delete'); if (delBtn) delBtn.disabled = true;
            }
          }catch(e){
            document.getElementById('beta-emp-list').innerHTML = '<li class="muted" style="padding:8px 10px;">読み込みに失敗しました</li>';
            betaSelectedId = null;
            document.getElementById('beta-msg').textContent = e.message||'従業員の取得に失敗しました';
            const delBtn = document.getElementById('beta-delete'); if (delBtn) delBtn.disabled = true;
          }
        }
        async function betaLoadDetail(id){
          try{
            const j = await betaFetch(`/api/employees/${id}`);
            const emp = (j&&j.data)||null; if(!emp) throw new Error('従業員が見つかりません');
            betaSelectedId = emp.id;
            document.querySelectorAll('#beta-emp-list li').forEach(li => {
              li.classList.toggle('active', li.dataset.empId === String(emp.id));
            });
            document.getElementById('beta-name').value = emp.name||'';
            document.getElementById('beta-role').value = emp.role||'';
            const ap = emp.assignPriority; const shown = Math.max(1, Math.min(5, parseInt(ap??3,10)||3));
            document.getElementById('beta-priority').value = shown;
            document.getElementById('beta-order').value = emp.displayOrder ?? '';
            document.getElementById('beta-msg').textContent='';
            // If the active tab is skills/rules/availability/pto, refresh that panel for the newly selected employee
            const activeTab = (document.querySelector('.beta-tab.active')?.getAttribute('data-tab')) || 'basic';
            if (activeTab==='skills') { betaEmpSkillsSet = new Set(); await betaLoadSkills(); }
            if (activeTab==='rules') { await betaLoadRule(); }
            if (activeTab==='availability') { await betaLoadAvailability(); }
            if (activeTab==='fixed') { await betaLoadFixedShifts(); }
            if (activeTab==='pto') { await betaLoadPto(); }
          }catch(e){ document.getElementById('beta-msg').textContent = e.message||'詳細の取得に失敗しました'; }
        }
        function betaSwitchTab(key){
          document.querySelectorAll('.beta-tab').forEach(t=>{ t.classList.toggle('active', t.getAttribute('data-tab')===key); });
          document.querySelectorAll('#beta-panel-basic,#beta-panel-skills,#beta-panel-rules,#beta-panel-availability,#beta-panel-fixed,#beta-panel-pto').forEach(el=>{ el.style.display='none'; });
          const map = {basic:'#beta-panel-basic', skills:'#beta-panel-skills', rules:'#beta-panel-rules', availability:'#beta-panel-availability', fixed:'#beta-panel-fixed', pto:'#beta-panel-pto'};
          const sel = document.querySelector(map[key]||'#beta-panel-basic'); if (sel) sel.style.display='block';
          if (key==='skills') { betaLoadSkills(); }
          if (key==='rules') { betaLoadRule(); }
          if (key==='availability') { betaLoadAvailability(); }
          if (key==='fixed') { betaLoadFixedShifts(); }
          if (key==='pto') { betaLoadPto(); }
        }
        function betaPatternPreview(str){
          const preview = document.getElementById('pattern-preview');
          if (preview) preview.textContent = `現在のパターン: ${str && str.length ? str : 'ー'}`;
        }
        function refreshPatternStrictHint(){
          const checkbox = document.getElementById('beta-rule-strict');
          const patternInput = document.getElementById('beta-rule-pattern');
          const hint = document.getElementById('pattern-strict-hint');
          if (!patternInput) {
            if (hint) hint.style.display = 'none';
            return;
          }
          const hasPattern = (patternInput.value || '').trim().length > 0;
          if (checkbox && !patternStrictTouched && hasPattern && !checkbox.checked) {
            checkbox.checked = true;
          }
          if (hint) {
            hint.style.display = (checkbox && hasPattern && !checkbox.checked) ? 'block' : 'none';
          }
        }
        function betaPatternSyncFromInput(){
          const input = document.getElementById('beta-rule-pattern');
          if (!input) return;
          const str = (input.value || '').trim();
          betaPatternBlocks = [];
          const regex = /(\d+)\s*([WO])/gi;
          let match;
          while ((match = regex.exec(str)) !== null){
            const count = parseInt(match[1], 10);
            const type = match[2] && match[2].toUpperCase() === 'O' ? 'O' : 'W';
            if (!Number.isNaN(count) && count > 0){
              betaPatternBlocks.push({ type, value: count });
            }
          }
          betaPatternPreview(str);
          refreshPatternStrictHint();
        }
        function betaPatternBlocksToString(){
          if (!betaPatternBlocks || !betaPatternBlocks.length) return '';
          return betaPatternBlocks.map(block => `${block.value}${block.type}`).join('-');
        }
        function betaPatternAddBlock(){
          betaPatternSyncFromInput();
          const msgEl = document.getElementById('beta-rule-msg');
          const work = parseInt(document.getElementById('pattern-work-days').value, 10) || 0;
          const off = parseInt(document.getElementById('pattern-off-days').value, 10) || 0;
          if (work <= 0 && off <= 0){
            if (msgEl) msgEl.textContent = '勤務日数または休日日数を1以上で入力してください';
            return;
          }
          if (work > 0) betaPatternBlocks.push({ type:'W', value: work });
          if (off > 0) betaPatternBlocks.push({ type:'O', value: off });
          const next = betaPatternBlocksToString();
          const input = document.getElementById('beta-rule-pattern');
          if (input) input.value = next;
          betaPatternPreview(next);
          if (msgEl) msgEl.textContent = '';
          refreshPatternStrictHint();
        }
        function betaPatternClear(){
          betaPatternBlocks = [];
          const input = document.getElementById('beta-rule-pattern');
          if (input) input.value = '';
          betaPatternPreview('');
          const msgEl = document.getElementById('beta-rule-msg');
          if (msgEl) msgEl.textContent = '';
          refreshPatternStrictHint();
        }
        async function betaSaveBasic(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-msg').textContent='従業員を選択してください'; return; }
          const name = document.getElementById('beta-name').value.trim();
          const role = document.getElementById('beta-role').value.trim();
          let assignPriority = parseInt(document.getElementById('beta-priority').value,10);
          if (isNaN(assignPriority)) assignPriority = 3; assignPriority = Math.max(1, Math.min(5, assignPriority));
          let displayOrder = parseInt(document.getElementById('beta-order').value,10);
          if (Number.isNaN(displayOrder)) displayOrder = null;
          try{
            await betaFetch(`/api/employees/${id}`, { method:'PUT', body: JSON.stringify({ name, role, assignPriority, displayOrder }) });
            document.getElementById('beta-msg').textContent='保存しました';
            await betaLoadList(id);
          }catch(e){ document.getElementById('beta-msg').textContent = e.message||'保存に失敗しました'; }
        }
        function toggleBetaCreate(force){
          const form = document.getElementById('beta-create-form');
          if(!form) return;
          const currentlyShown = form.style.display !== 'none';
          const show = force !== undefined ? force : !currentlyShown;
          form.style.display = show ? 'grid' : 'none';
          if (!show){
            document.getElementById('beta-create-name').value = '';
            document.getElementById('beta-create-role').value = '';
            document.getElementById('beta-create-order').value = '';
            setBetaCreateMsg('');
          } else {
            document.getElementById('beta-create-name').focus();
            document.getElementById('beta-create-order').value = betaNextDisplayOrder();
          }
        }
        function setBetaCreateMsg(text, isError=false){
          const el = document.getElementById('beta-create-msg');
          if(!el) return;
          el.textContent = text || '';
          el.style.color = isError ? '#b91c1c' : '#64748b';
        }
        async function betaCreateEmployee(){
          const name = document.getElementById('beta-create-name').value.trim();
          const role = document.getElementById('beta-create-role').value.trim();
          let displayOrder = parseInt(document.getElementById('beta-create-order').value,10);
          if (Number.isNaN(displayOrder)) displayOrder = null;
          if(!name){ setBetaCreateMsg('氏名は必須です', true); return; }
          try{
            const resp = await betaFetch('/api/employees', { method:'POST', body: JSON.stringify({ name, role, displayOrder }) });
            const newId = (resp && resp.data && resp.data.id) || resp?.id || null;
            document.getElementById('beta-msg').textContent = resp?.message || '従業員を追加しました';
            toggleBetaCreate(false);
            await betaLoadList(newId);
          }catch(e){
            setBetaCreateMsg(e.message||'追加に失敗しました', true);
          }
        }
        async function betaDeleteEmployee(){
          const id = betaSelectedId;
          if(!id){ return; }
          if(!confirm('この従業員を削除しますか？')) return;
          try{
            await betaFetch(`/api/employees/${id}`, { method:'DELETE' });
            document.getElementById('beta-msg').textContent = '削除しました';
            await betaLoadList();
          }catch(e){
            document.getElementById('beta-msg').textContent = e.message||'削除に失敗しました';
          }
        }
        betaRenderFixedTable();
        // events
        document.getElementById('beta-q').addEventListener('input', betaApplyFilter);
        document.getElementById('beta-refresh').addEventListener('click', ()=>betaLoadList(betaSelectedId));
        document.getElementById('beta-create-toggle').addEventListener('click', ()=>toggleBetaCreate());
        document.getElementById('beta-create-save').addEventListener('click', betaCreateEmployee);
        document.getElementById('beta-create-cancel').addEventListener('click', ()=>toggleBetaCreate(false));
        document.getElementById('beta-delete').addEventListener('click', betaDeleteEmployee);
        document.getElementById('beta-save-basic').addEventListener('click', betaSaveBasic);
        document.querySelectorAll('.beta-tab').forEach(t=> t.addEventListener('click', ()=> betaSwitchTab(t.getAttribute('data-tab'))));
        document.getElementById('beta-skill-search').addEventListener('click', betaLoadSkills);
        document.getElementById('beta-skill-save').addEventListener('click', betaSaveSkills);
        document.getElementById('beta-rule-save').addEventListener('click', betaSaveRule);
        const patternStrictCheckboxEl = document.getElementById('beta-rule-strict');
        if (patternStrictCheckboxEl) {
          patternStrictCheckboxEl.addEventListener('change', () => {
            patternStrictTouched = true;
            refreshPatternStrictHint();
          });
        }
        const patternAddBtn = document.getElementById('pattern-add');
        if (patternAddBtn) patternAddBtn.addEventListener('click', betaPatternAddBlock);
        const patternClearBtn = document.getElementById('pattern-clear');
        if (patternClearBtn) patternClearBtn.addEventListener('click', betaPatternClear);
        const patternInput = document.getElementById('beta-rule-pattern');
        if (patternInput) patternInput.addEventListener('input', betaPatternSyncFromInput);
        document.getElementById('beta-av-add').addEventListener('click', betaAvAdd);
        document.getElementById('beta-av-clear').addEventListener('click', betaAvClear);
        document.getElementById('beta-av-save').addEventListener('click', betaAvSave);
        const betaFixedTable = document.getElementById('beta-fixed-tbody');
        if (betaFixedTable) {
          betaFixedTable.addEventListener('input', betaHandleFixedInput);
          betaFixedTable.addEventListener('change', betaHandleFixedInput);
        }
        document.getElementById('beta-fixed-reset').addEventListener('click', betaFixedReset);
        document.getElementById('beta-fixed-save').addEventListener('click', betaSaveFixedShifts);
        document.getElementById('beta-pto-grant').addEventListener('click', betaPtoGrant);
        document.getElementById('beta-pto-request').addEventListener('click', betaPtoRequest);
        // init
        toggleBetaCreate(false);
        const delBtnInit = document.getElementById('beta-delete'); if (delBtnInit) delBtnInit.disabled = true;
        betaPatternSyncFromInput();
        betaLoadList();

        // ===== Skills Tab Logic =====
        let betaAllSkillsCache = [];
        let betaEmpSkillsSet = new Set();
        async function betaLoadSkills(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-skill-msg').textContent='従業員を選択してください'; return; }
          const q = (document.getElementById('beta-skill-q').value||'').trim();
          try{
            const [all, mine] = await Promise.all([
              betaFetch(`/api/skills${q? ('?query='+encodeURIComponent(q)) : ''}`),
              betaFetch(`/api/employees/${id}/skills`)
            ]);
            betaAllSkillsCache = (all && all.data) ? all.data : [];
            const mineList = (mine && mine.data) ? mine.data : [];
            betaEmpSkillsSet = new Set(mineList.map(s => s.id));
            betaRenderSkills();
            document.getElementById('beta-skill-msg').textContent='';
          }catch(e){ document.getElementById('beta-skill-msg').textContent = e.message||'読み込みに失敗しました'; }
        }
        function betaRenderSkills(){
          const listHost = document.getElementById('beta-skill-list');
          const mineHost = document.getElementById('beta-emp-skill-list');
          if (!listHost || !mineHost) return;
          // render all list with checkboxes
          if (betaAllSkillsCache.length===0){ listHost.innerHTML = '<div class="muted">スキルが見つかりません</div>'; }
          else {
            listHost.innerHTML = betaAllSkillsCache.map(s => {
              const checked = betaEmpSkillsSet.has(s.id) ? 'checked' : '';
              const code = (s.code||'').toString(); const name = (s.name||'').toString();
              return `<label style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #f1f5f9;"><input type="checkbox" data-skill-id="${s.id}" ${checked}/> <span style="min-width:80px;font-weight:600;">${code}</span> <span>${name}</span></label>`;
            }).join('');
            listHost.querySelectorAll('input[type="checkbox"][data-skill-id]').forEach(cb => {
              cb.addEventListener('change', (e)=>{
                const sid = Number(e.currentTarget.getAttribute('data-skill-id'));
                if (e.currentTarget.checked) betaEmpSkillsSet.add(sid); else betaEmpSkillsSet.delete(sid);
                betaRenderMine();
              });
            });
          }
          betaRenderMine();
        }
        function betaRenderMine(){
          const mineHost = document.getElementById('beta-emp-skill-list');
          const byId = new Map(betaAllSkillsCache.map(s => [s.id, s]));
          const mine = Array.from(betaEmpSkillsSet).map(id => byId.get(id)).filter(Boolean);
          if (mine.length===0){ mineHost.innerHTML = '<li class="muted">なし</li>'; return; }
          mineHost.innerHTML = mine.map(s => `<li><span style="display:inline-block;min-width:80px;font-weight:600;">${s.code||''}</span> ${(s.name||'')}</li>`).join('');
        }
        async function betaSaveSkills(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-skill-msg').textContent='従業員を選択してください'; return; }
          try{
            const arr = Array.from(betaEmpSkillsSet);
            await betaFetch(`/api/employees/${id}/skills`, { method:'PUT', body: JSON.stringify(arr) });
            document.getElementById('beta-skill-msg').textContent='保存しました';
          }catch(e){ document.getElementById('beta-skill-msg').textContent = e.message||'保存に失敗しました'; }
        }

        // ===== Rules Tab Logic =====
        async function betaLoadRule(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-rule-msg').textContent='従業員を選択してください'; return; }
          try{
            const j = await betaFetch(`/api/employees/${id}/rule`);
            const r = (j&&j.data)||{};
            document.getElementById('beta-rule-weeklyMax').value = r.weeklyMaxHours ?? '';
            document.getElementById('beta-rule-dailyMax').value = r.dailyMaxHours ?? '';
            document.getElementById('beta-rule-maxConsec').value = r.maxConsecutiveDays ?? '';
            document.getElementById('beta-rule-minRest').value = r.minRestHours ?? '';
            document.getElementById('beta-rule-allowMulti').checked = !!r.allowMultipleShiftsPerDay;
            document.getElementById('beta-rule-allowHoliday').checked = !!r.allowHolidayWork;
            document.getElementById('beta-rule-weeklyRest').value = r.weeklyRestDays ?? '';
            document.getElementById('beta-rule-pattern').value = r.workOffPattern || '';
            document.getElementById('beta-rule-anchor').value = r.patternAnchorDate || '';
            document.getElementById('beta-rule-strict').checked = !!r.patternStrict;
            document.getElementById('beta-rule-msg').textContent = '';
            patternStrictTouched = false;
            betaPatternSyncFromInput();
          }catch(e){ document.getElementById('beta-rule-msg').textContent = e.message||'取得に失敗しました'; }
        }
        async function betaSaveRule(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-rule-msg').textContent='従業員を選択してください'; return; }
          const body = {
            weeklyMaxHours: parseInt(document.getElementById('beta-rule-weeklyMax').value||''),
            dailyMaxHours: parseInt(document.getElementById('beta-rule-dailyMax').value||''),
            maxConsecutiveDays: parseInt(document.getElementById('beta-rule-maxConsec').value||''),
            minRestHours: parseInt(document.getElementById('beta-rule-minRest').value||''),
            allowMultipleShiftsPerDay: document.getElementById('beta-rule-allowMulti').checked,
            allowHolidayWork: document.getElementById('beta-rule-allowHoliday').checked,
            weeklyRestDays: parseInt(document.getElementById('beta-rule-weeklyRest').value||''),
            workOffPattern: (document.getElementById('beta-rule-pattern').value||'').trim() || null,
            patternAnchorDate: document.getElementById('beta-rule-anchor').value || null,
            patternStrict: document.getElementById('beta-rule-strict').checked
          };
          // remove NaN
          Object.keys(body).forEach(k => { if (typeof body[k]==='number' && Number.isNaN(body[k])) delete body[k]; });
          if (!body.workOffPattern) delete body.workOffPattern;
          if (!body.patternAnchorDate) delete body.patternAnchorDate;
          try{
            await betaFetch(`/api/employees/${id}/rule`, { method:'PUT', body: JSON.stringify(body)});
            document.getElementById('beta-rule-msg').textContent='保存しました';
          }catch(e){ document.getElementById('beta-rule-msg').textContent = e.message||'保存に失敗しました'; }
        }
        // ===== Availability Tab Logic =====
        async function betaLoadAvailability(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-av-msg').textContent='従業員を選択してください'; return; }
          try{
            const j = await betaFetch(`/api/employees/${id}/availability`);
            betaAvList = (j&&j.data)||[];
            betaAvRender();
            document.getElementById('beta-av-msg').textContent='';
          }catch(e){ document.getElementById('beta-av-msg').textContent = e.message||'取得に失敗しました'; }
        }
        function betaAvRender(){
          const tbody = document.getElementById('beta-av-tbody');
          if (!betaAvList || betaAvList.length===0){ tbody.innerHTML = '<tr><td colspan="4" class="muted">なし</td></tr>'; return; }
          tbody.innerHTML = betaAvList.map((a,i)=>{
            const s = (a.startTime||'').toString().slice(0,5); const e = (a.endTime||'').toString().slice(0,5);
            const d = a.dayOfWeek;
            return `<tr><td>${betaDowLabel(d)}</td><td>${s}</td><td>${e}</td><td><button data-av-del="${i}">削除</button></td></tr>`;
          }).join('');
          tbody.querySelectorAll('button[data-av-del]').forEach(btn=> btn.addEventListener('click', (ev)=>{
            const idx = parseInt(ev.currentTarget.getAttribute('data-av-del'),10);
            betaAvList.splice(idx,1); betaAvRender();
          }));
        }
        function betaAvAdd(){
          const d = document.getElementById('beta-av-dow').value;
          const s = document.getElementById('beta-av-start').value;
          const e = document.getElementById('beta-av-end').value;
          if (!s || !e){ document.getElementById('beta-av-msg').textContent='開始/終了を入力してください'; return; }
          betaAvList.push({ dayOfWeek:d, startTime:s, endTime:e });
          betaAvRender();
        }
        function betaAvClear(){ betaAvList = []; betaAvRender(); }
        async function betaAvSave(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-av-msg').textContent='従業員を選択してください'; return; }
          try{
            await betaFetch(`/api/employees/${id}/availability`, { method:'PUT', body: JSON.stringify(betaAvList) });
            document.getElementById('beta-av-msg').textContent='保存しました';
          }catch(e){ document.getElementById('beta-av-msg').textContent = e.message||'保存に失敗しました'; }
        }

        // ===== Fixed Shift Tab Logic =====
        function betaEnsureFixedState(){
          if (!Array.isArray(betaFixedState) || betaFixedState.length === 0) {
            betaInitFixedState();
            return;
          }
          const map = {};
          betaFixedState.forEach(item => { if (item && item.dayOfWeek) map[item.dayOfWeek] = item; });
          betaFixedState = betaFixedDays.map(day => {
            const match = map[day.key] || {};
            return {
              dayOfWeek: day.key,
              label: day.label,
              active: !!match.active,
              startTime: (match.startTime || '09:00').slice(0,5),
              endTime: (match.endTime || '18:00').slice(0,5),
              note: match.note || ''
            };
          });
        }
        function betaRenderFixedTable(){
          betaEnsureFixedState();
          const tbody = document.getElementById('beta-fixed-tbody');
          if (!tbody) return;
          tbody.innerHTML = betaFixedState.map(item => {
            const checked = item.active ? 'checked' : '';
            return `<tr data-day="${item.dayOfWeek}">
              <td>${item.label}</td>
              <td style="text-align:center;"><input type="checkbox" data-day="${item.dayOfWeek}" data-kind="active" ${checked}/></td>
              <td><input type="time" data-day="${item.dayOfWeek}" data-kind="start" value="${item.startTime || ''}"/></td>
              <td><input type="time" data-day="${item.dayOfWeek}" data-kind="end" value="${item.endTime || ''}"/></td>
              <td><input type="text" data-day="${item.dayOfWeek}" data-kind="note" value="${item.note || ''}" placeholder="例) 送迎対応"/></td>
            </tr>`;
          }).join('');
        }
        async function betaLoadFixedShifts(){
          const id = betaSelectedId;
          const msgEl = document.getElementById('beta-fixed-msg');
          if (!id) {
            betaInitFixedState(); betaRenderFixedTable();
            if (msgEl) msgEl.textContent = '従業員を選択してください';
            return;
          }
          try{
            const resp = await betaFetch(`/api/employees/${id}/fixed-shifts`);
            const data = resp?.data || [];
            betaInitFixedState();
            data.forEach(item => {
              if (!item || !item.dayOfWeek) return;
              const row = betaFixedState.find(x => x.dayOfWeek === item.dayOfWeek);
              if (!row) return;
              row.active = item.active !== false;
              row.startTime = (item.startTime || '09:00').slice(0,5);
              row.endTime = (item.endTime || '18:00').slice(0,5);
              row.note = item.note || '';
            });
            betaRenderFixedTable();
            if (msgEl) msgEl.textContent = '';
          }catch(e){
            betaInitFixedState(); betaRenderFixedTable();
            if (msgEl) msgEl.textContent = e.message || '取得に失敗しました';
          }
        }
        function betaHandleFixedInput(ev){
          const target = ev.target;
          if (!target || !target.dataset) return;
          const day = target.dataset.day;
          const kind = target.dataset.kind;
          if (!day || !kind) return;
          const item = betaFixedState.find(x => x.dayOfWeek === day);
          if (!item) return;
          if (kind === 'active') item.active = target.checked;
          if (kind === 'start') item.startTime = target.value;
          if (kind === 'end') item.endTime = target.value;
          if (kind === 'note') item.note = target.value;
        }
        function betaFixedReset(){
          betaInitFixedState();
          betaRenderFixedTable();
          const msgEl = document.getElementById('beta-fixed-msg');
          if (msgEl) msgEl.textContent = '';
        }
        function betaFixedMinutes(str){
          if (!str) return null;
          const parts = str.split(':');
          if (parts.length < 2) return null;
          const h = parseInt(parts[0],10);
          const m = parseInt(parts[1],10);
          if (Number.isNaN(h) || Number.isNaN(m)) return null;
          return h*60 + m;
        }
        async function betaSaveFixedShifts(){
          const id = betaSelectedId;
          const msgEl = document.getElementById('beta-fixed-msg');
          if (!id){ if (msgEl) msgEl.textContent = '従業員を選択してください'; return; }
          const payload = [];
          for (const item of betaFixedState){
            if (!item.active) continue;
            const startMin = betaFixedMinutes(item.startTime);
            const endMin = betaFixedMinutes(item.endTime);
            if (startMin == null || endMin == null || startMin >= endMin){
              if (msgEl) msgEl.textContent = `${item.label}の時間帯が不正です`;
              return;
            }
            payload.push({
              dayOfWeek: item.dayOfWeek,
              startTime: item.startTime,
              endTime: item.endTime,
              note: item.note,
              active: true
            });
          }
          try{
            await betaFetch(`/api/employees/${id}/fixed-shifts`, { method:'PUT', body: JSON.stringify(payload) });
            if (msgEl) msgEl.textContent = '保存しました';
          }catch(e){
            if (msgEl) msgEl.textContent = e.message || '保存に失敗しました';
          }
        }

        // ===== PTO Tab Logic =====
        async function betaLoadPto(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-pto-msg').textContent='従業員を選択してください'; return; }
          try{
            const j = await betaFetch(`/api/leave/balance/${id}`);
            const d = (j&&j.data)||{};
            document.getElementById('beta-pto-annual').textContent = d.annualGranted ?? 0;
            document.getElementById('beta-pto-carried').textContent = d.carriedOver ?? 0;
            document.getElementById('beta-pto-used').textContent = d.used ?? 0;
            document.getElementById('beta-pto-remaining').textContent = d.remaining ?? 0;
            document.getElementById('beta-pto-msg').textContent = '';
          }catch(e){ document.getElementById('beta-pto-msg').textContent = e.message||'取得に失敗しました'; }
        }
        async function betaPtoGrant(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-pto-msg').textContent='従業員を選択してください'; return; }
          let days = parseInt(document.getElementById('beta-pto-grantDays').value,10); if (isNaN(days)||days<=0) days=1;
          try{
            await betaFetch('/api/leave/balance/grant', { method:'POST', body: JSON.stringify({ employeeId: id, days }) });
            document.getElementById('beta-pto-msg').textContent = '付与しました';
            await betaLoadPto();
          }catch(e){ document.getElementById('beta-pto-msg').textContent = e.message||'付与に失敗しました'; }
        }
        async function betaPtoRequest(){
          const id = betaSelectedId; if(!id){ document.getElementById('beta-pto-msg').textContent='従業員を選択してください'; return; }
          const date = document.getElementById('beta-pto-date').value; if (!date){ document.getElementById('beta-pto-msg').textContent='日付を選択してください'; return; }
          try{
            await betaFetch('/api/leave/requests', { method:'POST', body: JSON.stringify({ employeeId: id, date }) });
            document.getElementById('beta-pto-msg').textContent = '登録しました';
            await betaLoadPto();
          }catch(e){ document.getElementById('beta-pto-msg').textContent = e.message||'登録に失敗しました'; }
        }
      </script>
    </div>
  </div>
</body>
</html>
