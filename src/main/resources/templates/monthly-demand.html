<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>月間需要エディタ</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; margin:0; background:#f5f7fb; color:#0f172a; }
    .container { max-width: 1280px; margin: 0 auto; padding: 24px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; }
    .split { display:grid; grid-template-columns: 1.1fr 1fr; gap:16px; }
    input, select, button { padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1; }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    button.ghost { background:#f1f5f9; color:#0f172a; }
    .muted { color:#64748b; font-size:12px; }
    .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .cell { background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:10px; min-height:92px; cursor:pointer; }
    .cell.selected { outline:2px solid #2563eb; }
    .cell .date { font-weight:600; color:#0f172a; }
    .cell .sum { display:inline-block; margin-top:6px; background:#eef2ff; color:#1e3a8a; border-radius:999px; padding:2px 8px; font-size:12px; }
    .cell.other { background:#f8fafc; color:#94a3b8; }
    .header { display:grid; grid-template-columns: repeat(7, 1fr); margin-bottom:6px; color:#475569; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #e2e8f0; text-align:left; padding:6px; font-size:14px; }
    .right .row { margin-bottom:8px; }
    .actions { display:flex; gap:6px; }
    .danger { background:#ef4444; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="margin:0 0 12px;">月間需要エディタ</h2>
    <div class="card row" style="justify-content:space-between;">
      <div class="row">
        <label>年月 <input type="month" id="ym" /></label>
        <label>既定座席 <input type="number" id="defaultSeats" min="0" value="5" style="width:80px;" /></label>
        <label>スキル <select id="skillSelect" style="min-width:180px;"><option value="">選択</option></select></label>
      </div>
      <div class="row">
        <button id="btnGenerate" title="この月を需要ベースで生成">この月を生成</button>
        <a class="ghost" href="/dashboard" style="text-decoration:none; padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1;">ダッシュボード</a>
      </div>
    </div>

    <div class="split">
      <div class="left card">
        <div class="header">
          <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
        </div>
        <div id="grid" class="grid"></div>
      </div>
      <div class="right card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <span id="panelDate" style="font-weight:600;"></span>
            <span id="panelSummary" class="muted" style="margin-left:8px;"></span>
          </div>
          <div class="row">
            <button id="btnAddAM" class="ghost" disabled>AM追加</button>
            <button id="btnAddPM" class="ghost" disabled>PM追加</button>
            <button id="btnAddFull" class="ghost" disabled>フル追加</button>
          </div>
        </div>
        <div class="row">
          <label>開始 <input type="time" id="f_start" value="09:00" /></label>
          <label>終了 <input type="time" id="f_end" value="18:00" /></label>
          <label>座席 <input type="number" id="f_seats" min="0" value="5" style="width:80px;" /></label>
          <button id="btnAdd">追加</button>
        </div>
        <div id="list"></div>
      </div>
    </div>
  </div>

  <script>
    let state = { year: null, month: null, days: {}, pairing: null, skills: [], selectedDate: null };

    function firstOfMonth(y, m){ return new Date(y, m-1, 1); }
    function startOfCalendar(date){ const d=new Date(date); const w=d.getDay(); d.setDate(d.getDate()-w); return d; }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtDate(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
    function parseWin(win){ const [s,e]=win.split('-'); return {s,e}; }

    async function loadSkills(){
      const r = await fetch('/api/skills'); const j = await r.json(); state.skills = j.data||[];
      const sel = document.getElementById('skillSelect');
      sel.innerHTML = '<option value="">選択</option>' + state.skills.map(s=>`<option value="${s.id}">${s.name||s.code||('#'+s.id)}</option>`).join('');
    }
    async function loadPairing(){
      try{ const r = await fetch('/api/config/pairing-settings'); state.pairing = await r.json(); }catch(e){ state.pairing=null; }
    }
    async function loadDay(dateStr){
      const r = await fetch(`/api/demand?date=${dateStr}`);
      const j = await r.json();
      state.days[dateStr] = j.data||[];
    }
    async function loadMonth(){
      // prefetch each day on demand when rendering cells
      renderCalendar();
    }
    function sumSeats(list){ return (list||[]).reduce((a,b)=> a + (b.requiredSeats||0), 0); }
    function cellSkillBadgeSum(list){ return sumSeats(list); }
    function weekdayName(i){ return ['日','月','火','水','木','金','土'][i]; }

    async function renderCalendar(){
      const grid = document.getElementById('grid'); grid.innerHTML='';
      const base = firstOfMonth(state.year, state.month);
      const start = startOfCalendar(base);
      const ymStr = `${state.year}-${String(state.month).padStart(2,'0')}`;
      const promises=[]; // lazy fetch current month days
      for(let i=0;i<42;i++){
        const d = addDays(start, i); const ds = fmtDate(d);
        const cell = document.createElement('div');
        cell.id = `cell-${ds}`;
        cell.className = 'cell' + (d.getMonth()+1!==state.month? ' other':'' );
        cell.innerHTML = `<div class="date">${d.getDate()}</div><div class="sum" id="sum-${ds}">…</div>`;
        cell.addEventListener('click', ()=> selectDate(ds));
        grid.appendChild(cell);
        // fetch this day if in target month
        if (d.getMonth()+1===state.month){ promises.push(loadDay(ds).then(()=>{
          document.getElementById(`sum-${ds}`).textContent = `合計 ${cellSkillBadgeSum(state.days[ds])}`;
        })); } else {
          document.getElementById(`sum-${ds}`).textContent = '';
        }
      }
      await Promise.all(promises);
      // auto-select today if in month, else first day in month
      const today = new Date();
      const todayStr = fmtDate(today);
      const def = (today.getFullYear()===state.year && (today.getMonth()+1)===state.month) ? todayStr : fmtDate(base);
      selectDate(def);
    }

    function skillLabel(s){ return s ? (s.name||s.code||('#'+s.id)) : ''; }
    function findSkill(id){ return state.skills.find(s=> String(s.id)===String(id)); }

    function renderList(){
      const list = document.getElementById('list');
      const rows = state.days[state.selectedDate]||[];
      const total = sumSeats(rows);
      document.getElementById('panelSummary').textContent = `需要合計: ${total}`;
      let html = '<table><thead><tr><th>時間帯</th><th>座席</th><th>スキル</th><th></th></tr></thead><tbody>';
      for(const r of rows){
        const sk = r.skill ? skillLabel(r.skill) : '';
        html += `<tr data-id="${r.id}">
          <td>${(r.startTime||'').slice(0,5)} - ${(r.endTime||'').slice(0,5)}</td>
          <td>${r.requiredSeats}</td>
          <td>${sk}</td>
          <td class="actions">
            <button class="ghost btn-edit" data-id="${r.id}">編集</button>
            <button class="danger btn-del" data-id="${r.id}">削除</button>
          </td>
        </tr>`;
      }
      html += '</tbody></table>';
      list.innerHTML = html;
      list.querySelectorAll('.btn-del').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm(`需要ID=${id} を削除しますか？`)) return;
          const res = await fetch(`/api/demand/${id}`, { method:'DELETE' });
          if(!res.ok){ alert('削除に失敗しました'); return; }
          await loadDay(state.selectedDate); renderList();
          document.getElementById(`sum-${state.selectedDate}`).textContent = `合計 ${cellSkillBadgeSum(state.days[state.selectedDate])}`;
        });
      });
      list.querySelectorAll('.btn-edit').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(e.currentTarget.getAttribute('data-id'));
          const row = (state.days[state.selectedDate]||[]).find(x=>x.id===id);
          if(!row) return;
          document.getElementById('f_start').value = (row.startTime||'').slice(0,5);
          document.getElementById('f_end').value = (row.endTime||'').slice(0,5);
          document.getElementById('f_seats').value = row.requiredSeats;
          document.getElementById('skillSelect').value = row.skill ? String(row.skill.id) : '';
          // update mode: clicking 追加 acts as更新 for selected row
          document.getElementById('btnAdd').textContent = '更新';
          document.getElementById('btnAdd').dataset.editId = String(row.id);
        });
      });
    }

    async function selectDate(dateStr){
      state.selectedDate = dateStr;
      document.getElementById('panelDate').textContent = dateStr;
      // highlight selection
      document.querySelectorAll('.cell.selected').forEach(el=> el.classList.remove('selected'));
      const el = document.getElementById(`cell-${dateStr}`); if (el) el.classList.add('selected');
      if (!state.days[dateStr]){ await loadDay(dateStr); }
      renderList();
    }

    async function createOrUpdateByForm(win){
      const start = win?.s || document.getElementById('f_start').value;
      const end = win?.e || document.getElementById('f_end').value;
      const seats = Number(document.getElementById('f_seats').value||document.getElementById('defaultSeats').value||0);
      const skillIdStr = document.getElementById('skillSelect').value;
      const skillId = skillIdStr? Number(skillIdStr): null;
      if (!state.selectedDate){ alert('日付が未選択です'); return; }
      if (!skillId){ alert('スキルを選択してください'); return; }
      if (!start || !end || start>=end){ alert('時間帯が不正です'); return; }
      if (seats<0){ alert('座席は0以上'); return; }
      const editId = document.getElementById('btnAdd').dataset.editId;
      const body = { date: state.selectedDate, dayOfWeek: null, startTime: start, endTime: end, requiredSeats: seats, skillId, active: true };
      const url = editId ? `/api/demand/${editId}` : '/api/demand';
      const method = editId ? 'PUT' : 'POST';
      const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(!r.ok){ try{ const j=await r.json(); alert(j.message||'保存に失敗しました'); }catch(e){ alert('保存に失敗しました'); } return; }
      // reset edit mode
      document.getElementById('btnAdd').textContent = '追加'; delete document.getElementById('btnAdd').dataset.editId;
      await loadDay(state.selectedDate); renderList();
      document.getElementById(`sum-${state.selectedDate}`).textContent = `合計 ${cellSkillBadgeSum(state.days[state.selectedDate])}`;
    }

    function bindEvents(){
      document.getElementById('btnAdd').addEventListener('click', ()=> createOrUpdateByForm());
      document.getElementById('btnAddAM').addEventListener('click', ()=>{
        const ps = state.pairing; if(!ps){ alert('ペア設定の取得に失敗'); return; }
        const {s,e} = parseWin(ps.morningWindow||'09:00-13:00');
        createOrUpdateByForm({s,e});
      });
      document.getElementById('btnAddPM').addEventListener('click', ()=>{
        const ps = state.pairing; if(!ps){ alert('ペア設定の取得に失敗'); return; }
        const {s,e} = parseWin(ps.afternoonWindow||'13:00-18:00');
        createOrUpdateByForm({s,e});
      });
      document.getElementById('btnAddFull').addEventListener('click', ()=>{
        const ps = state.pairing; if(!ps){ alert('ペア設定の取得に失敗'); return; }
        const {s,e} = parseWin(ps.fullWindow||'09:00-18:00');
        createOrUpdateByForm({s,e});
      });
      const skillSel = document.getElementById('skillSelect');
      function updateQuick(){ const dis = !skillSel.value; ['btnAddAM','btnAddPM','btnAddFull'].forEach(id=>{ const b=document.getElementById(id); if(b){ b.disabled = dis; }}); }
      skillSel.addEventListener('change', updateQuick); updateQuick();
      document.getElementById('btnGenerate').addEventListener('click', async ()=>{
        const y = state.year, m = state.month; if(!y||!m) return;
        const url = `/api/schedule/generate/demand/async?year=${y}&month=${m}&granularity=60&reset=true`;
        try{ const r=await fetch(url,{method:'POST'}); const j=await r.json(); alert(j.message||'生成を開始しました'); }catch(e){ alert('生成に失敗しました'); }
      });
      document.getElementById('ym').addEventListener('change', ()=>{
        const v = document.getElementById('ym').value; if(!v) return; const y=Number(v.slice(0,4)), m=Number(v.slice(5));
        state.year=y; state.month=m; loadMonth();
      });
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      const today = new Date();
      const ym = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      document.getElementById('ym').value = ym;
      state.year = today.getFullYear(); state.month = today.getMonth()+1;
      document.getElementById('f_seats').value = document.getElementById('defaultSeats').value;
      bindEvents();
      await loadSkills();
      await loadPairing();
      await loadMonth();
    });
  </script>
</body>
</html>
