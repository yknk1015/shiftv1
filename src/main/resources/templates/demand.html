<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>需要管理</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #94a3b8;
      --accent: #2563eb;
      --accent-soft: #eef2ff;
      --danger: #ef4444;
    }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,'Segoe UI','Hiragino Sans','Yu Gothic',sans-serif; }
    .container { max-width:1200px; margin:0 auto; padding:24px; }
    h1 { margin:0 0 20px; }
    h3 { margin:0 0 12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    label { font-size:13px; color:#475569; display:flex; flex-direction:column; gap:4px; }
    input, select, button { font-size:14px; padding:8px 10px; border-radius:8px; border:1px solid var(--border); }
    button { background:var(--accent); color:#fff; border:none; cursor:pointer; }
    button.ghost { background:var(--accent-soft); color:#1d4ed8; border:1px solid #c7d2fe; }
    button.danger { background:var(--danger); color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid var(--border); text-align:left; padding:8px; font-size:14px; }
    th { color:#475569; font-weight:500; }
    .muted { color:var(--muted); font-size:13px; margin-top:6px; }
    .message { margin-top:8px; font-size:13px; }
    .weekly-table section { margin-top:14px; }
    .weekly-table h4 { margin:0 0 6px; font-size:15px; }
    .calendar-header { display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:6px; color:#475569; font-size:12px; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
    .calendar-cell { background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px; min-height:92px; cursor:pointer; }
    .calendar-cell.other { background:#f8fafc; color:#94a3b8; }
    .calendar-cell.selected { outline:2px solid var(--accent); }
    .calendar-cell .date { font-weight:600; }
    .calendar-cell .sum { display:inline-block; margin-top:6px; background:var(--accent-soft); color:#2e1065; border-radius:999px; padding:2px 8px; font-size:12px; }
    .monthly-layout { display:grid; grid-template-columns:1.1fr 1fr; gap:16px; }
    .monthly-panel { border:1px solid var(--border); border-radius:12px; padding:16px; background:#fff; }
    .monthly-actions { display:flex; gap:8px; flex-wrap:wrap; }
    @media (max-width:900px) { .monthly-layout { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>需要管理</h1>

    <section class="card">
      <h3>需要の確認</h3>
      <div class="row">
        <label>日付<input type="date" id="view-date" /></label>
        <button id="btn-view-effective">当日の需要を表示</button>
        <button id="btn-view-all" class="ghost">すべて表示</button>
        <button id="btn-view-sort" class="ghost">整頓</button>
      </div>
      <div id="effective" style="margin-top:12px"></div>
      <div id="all" style="margin-top:12px"></div>
    </section>

    <section class="card" id="weekly-card">
      <h3>曜日・祝日の需要テンプレート</h3>
      <div class="row">
        <label>曜日/祝
          <select id="weekly-day">
            <option value="MONDAY">月曜日</option>
            <option value="TUESDAY">火曜日</option>
            <option value="WEDNESDAY">水曜日</option>
            <option value="THURSDAY">木曜日</option>
            <option value="FRIDAY">金曜日</option>
            <option value="SATURDAY">土曜日</option>
            <option value="SUNDAY">日曜日</option>
            <option value="HOLIDAY">祝（祝日のみ）</option>
          </select>
        </label>
        <label>開始<input type="time" id="weekly-start" value="09:00" /></label>
        <label>終了<input type="time" id="weekly-end" value="18:00" /></label>
        <label>必要数<input type="number" id="weekly-required" min="0" value="5" style="width:90px" /></label>
        <label>スキル<select id="weekly-skill" style="min-width:180px;"></select></label>
        <button id="weekly-submit">登録 / 更新</button>
        <button id="weekly-cancel" class="ghost">キャンセル</button>
      </div>
      <div class="muted">曜日テンプレートは「曜日設定で初期化」ボタンで月間需要へ反映できます。「祝」は祝日のみ適用されます。</div>
      <div id="weekly-msg" class="message"></div>
      <div class="weekly-table" id="weekly-table"></div>
    </section>

    <section class="card" id="monthly-card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="row">
          <label>年月<input type="month" id="ym" /></label>
          <label>既定座席<input type="number" id="defaultSeats" min="0" value="5" style="width:80px;" /></label>
          <label>スキル<select id="skillSelect" style="min-width:180px;"><option value="">選択</option></select></label>
        </div>
        <div class="monthly-actions">
          <button id="btnApplyWeekly" class="ghost">曜日設定で初期化</button>
          <button id="btnGenerate" title="需要ベースでこの月を生成">この月を生成</button>
        </div>
      </div>
      <div class="monthly-layout" style="margin-top:16px;">
        <div>
          <div class="calendar-header">
            <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
          </div>
          <div id="grid" class="calendar-grid"></div>
        </div>
        <div class="monthly-panel">
          <div class="row" style="justify-content:space-between;">
            <div>
              <span id="panelDate" style="font-weight:600;"></span>
              <span id="panelSummary" class="muted" style="margin-left:8px;"></span>
            </div>
            <div class="row" style="gap:6px;">
              <button id="btnAddAM" class="ghost" disabled>AM追加</button>
              <button id="btnAddPM" class="ghost" disabled>PM追加</button>
              <button id="btnAddFull" class="ghost" disabled>フル追加</button>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <label>開始<input type="time" id="f_start" value="09:00" /></label>
            <label>終了<input type="time" id="f_end" value="18:00" /></label>
            <label>座席<input type="number" id="f_seats" min="0" value="5" style="width:80px;" /></label>
            <button id="btnAdd">追加</button>
          </div>
          <div id="monthly-msg" class="message"></div>
          <div id="list"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const DAY_LABELS = { MONDAY: '月', TUESDAY: '火', WEDNESDAY: '水', THURSDAY: '木', FRIDAY: '金', SATURDAY: '土', SUNDAY: '日', HOLIDAY: '祝' };
    const WEEKLY_ORDER = ['MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY','HOLIDAY'];
    let weeklyEditingId = null;
    const weeklyCache = new Map();
    const state = { year: null, month: null, days: {}, pairing: null, skills: [], selectedDate: null };

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, { credentials: 'include', headers: { 'Content-Type': 'application/json' }, ...options });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) throw new Error(data.message || 'リクエストに失敗しました');
      return data;
    }

    async function fetchWithTimeout(url, options = {}, timeout = 15000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const res = await fetch(url, { credentials: 'include', ...options, signal: controller.signal });
        clearTimeout(id);
        return res;
      } catch (err) {
        clearTimeout(id);
        throw err;
      }
    }

    async function loadEffective() {
      const date = document.getElementById('view-date').value;
      if (!date) { alert('日付を入力してください'); return; }
      try {
        const res = await fetchWithTimeout(`/api/demand/effective?date=${date}`);
        const j = await res.json();
        renderTable('effective', '当日適用', j.data || []);
      } catch {
        document.getElementById('effective').innerHTML = '<div class="muted">取得に失敗しました</div>';
      }
    }

    async function loadAll() {
      try {
        const res = await fetchWithTimeout('/api/demand');
        const j = await res.json();
        renderTable('all', 'すべて', j.data || []);
      } catch {
        document.getElementById('all').innerHTML = '<div class="muted">取得に失敗しました</div>';
      }
    }

    function renderTable(id, title, rows) {
      const host = document.getElementById(id);
      const html = [];
      html.push(`<div class="muted" style="margin-bottom:6px;">${title}</div>`);
      html.push('<table><thead><tr><th>ID</th><th>日付</th><th>曜日</th><th>開始</th><th>終了</th><th>必要数</th><th>スキル</th><th>祝</th></tr></thead><tbody>');
      if (!rows.length) {
        html.push('<tr><td colspan="8" class="muted">データがありません</td></tr>');
      }
      rows.forEach(r => {
        html.push(`<tr>
          <td>${r.id ?? ''}</td>
          <td>${r.date ?? ''}</td>
          <td>${r.dayOfWeek ?? ''}</td>
          <td>${(r.startTime || '').toString().slice(0,5)}</td>
          <td>${(r.endTime || '').toString().slice(0,5)}</td>
          <td>${r.requiredSeats ?? ''}</td>
          <td>${r.skill ? (r.skill.name || r.skill.code || ('#' + r.skill.id)) : ''}</td>
          <td>${r.holidayOnly ? '祝' : ''}</td>
        </tr>`);
      });
      html.push('</tbody></table>');
      host.innerHTML = html.join('');
    }

    async function tidyOrder() {
      try {
        await fetchWithTimeout('/api/demand/sort', { method: 'POST' });
        await loadAll();
      } catch {
        alert('整頓に失敗しました');
      }
    }

    async function loadWeeklySkills() {
      try {
        const res = await fetchWithTimeout('/api/skills');
        const j = await res.json();
        const list = j.data || [];
        document.getElementById('weekly-skill').innerHTML = list.map(s => `<option value="${s.id}">${s.name || s.code || ('#' + s.id)}</option>`).join('');
      } catch {
        document.getElementById('weekly-skill').innerHTML = '<option value="">取得失敗</option>';
      }
    }

    function setWeeklyMessage(text, success = false) {
      const el = document.getElementById('weekly-msg');
      if (!el) return;
      el.textContent = text || '';
      el.style.color = !text ? '' : (success ? '#15803d' : '#b91c1c');
    }

    async function refreshWeeklyTable() {
      weeklyCache.clear();
      const sections = [];
      for (const day of WEEKLY_ORDER) {
        const url = day === 'HOLIDAY' ? '/api/demand?holidayOnly=true' : `/api/demand?dayOfWeek=${day}`;
        try {
          const res = await fetchWithTimeout(url);
          const j = await res.json();
          const items = (j.data || []).sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
          items.forEach(r => weeklyCache.set(String(r.id), r));
          sections.push({ day, items });
        } catch {
          sections.push({ day, items: [] });
        }
      }
      const host = document.getElementById('weekly-table');
      host.innerHTML = sections.map(({ day, items }) => {
        const label = DAY_LABELS[day];
        if (!items.length) {
          return `<section><h4>${label}</h4><div class="muted">テンプレートは登録されていません</div></section>`;
        }
        const body = items.map(r => `<tr>
          <td>${(r.startTime || '').toString().slice(0,5)} - ${(r.endTime || '').toString().slice(0,5)}</td>
          <td>${r.requiredSeats ?? ''}</td>
          <td>${r.skill ? (r.skill.name || r.skill.code || ('#' + r.skill.id)) : ''}</td>
          <td>
            <button class="ghost" data-id="${r.id}" data-act="edit">編集</button>
            <button class="danger" data-id="${r.id}" data-act="delete">削除</button>
          </td>
        </tr>`).join('');
        return `<section><h4>${label}</h4><table><thead><tr><th>時間帯</th><th>座席</th><th>スキル</th><th></th></tr></thead><tbody>${body}</tbody></table></section>`;
      }).join('');
      host.querySelectorAll('button[data-act="edit"]').forEach(btn => btn.addEventListener('click', () => startWeeklyEdit(btn.dataset.id)));
      host.querySelectorAll('button[data-act="delete"]').forEach(btn => btn.addEventListener('click', () => deleteWeekly(btn.dataset.id)));
    }

    function resetWeeklyForm() {
      weeklyEditingId = null;
      document.getElementById('weekly-day').value = 'MONDAY';
      document.getElementById('weekly-start').value = '09:00';
      document.getElementById('weekly-end').value = '18:00';
      document.getElementById('weekly-required').value = 5;
      const sel = document.getElementById('weekly-skill');
      if (sel && sel.options.length) sel.selectedIndex = 0;
      setWeeklyMessage('');
    }

    function startWeeklyEdit(id) {
      const row = weeklyCache.get(String(id));
      if (!row) return;
      weeklyEditingId = Number(id);
      document.getElementById('weekly-day').value = row.holidayOnly ? 'HOLIDAY' : (row.dayOfWeek || 'MONDAY');
      document.getElementById('weekly-start').value = (row.startTime || '').toString().slice(0,5);
      document.getElementById('weekly-end').value = (row.endTime || '').toString().slice(0,5);
      document.getElementById('weekly-required').value = row.requiredSeats ?? 0;
      document.getElementById('weekly-skill').value = row.skill ? row.skill.id : '';
      setWeeklyMessage(`ID=${id} を編集中です`, true);
    }

    async function submitWeekly() {
      const dayValue = document.getElementById('weekly-day').value;
      const payload = {
        date: null,
        dayOfWeek: dayValue === 'HOLIDAY' ? null : dayValue,
        startTime: document.getElementById('weekly-start').value,
        endTime: document.getElementById('weekly-end').value,
        requiredSeats: Number(document.getElementById('weekly-required').value || 0),
        skillId: Number(document.getElementById('weekly-skill').value || 0),
        active: true,
        holidayOnly: dayValue === 'HOLIDAY'
      };
      if (!payload.skillId) {
        setWeeklyMessage('スキルを選択してください');
        return;
      }
      if (!payload.startTime || !payload.endTime || payload.startTime >= payload.endTime) {
        setWeeklyMessage('時間帯を確認してください');
        return;
      }
      const method = weeklyEditingId ? 'PUT' : 'POST';
      const url = weeklyEditingId ? `/api/demand/${weeklyEditingId}` : '/api/demand';
      try {
        await fetchWithTimeout(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        setWeeklyMessage('保存しました', true);
        resetWeeklyForm();
        await refreshWeeklyTable();
      } catch {
        setWeeklyMessage('保存に失敗しました');
      }
    }

    async function deleteWeekly(id) {
      if (!confirm(`ID=${id} を削除しますか?`)) return;
      try {
        await fetchWithTimeout(`/api/demand/${id}`, { method:'DELETE' });
        setWeeklyMessage('削除しました', true);
        if (Number(id) === weeklyEditingId) resetWeeklyForm();
        await refreshWeeklyTable();
      } catch {
        setWeeklyMessage('削除に失敗しました');
      }
    }

    function setMonthlyMessage(text, success = true) {
      const el = document.getElementById('monthly-msg');
      if (!el) return;
      el.textContent = text || '';
      el.style.color = !text ? '' : (success ? '#15803d' : '#b91c1c');
    }

    function firstOfMonth(y, m){ return new Date(y, m-1, 1); }
    function startOfCalendar(date){ const d=new Date(date); const w=d.getDay(); d.setDate(d.getDate()-w); return d; }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtDate(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0'); }
    function parseWin(win){ const [s,e]=win.split('-'); return {s,e}; }

    async function loadSkillsForMonthly(){
      try{
        const j = await fetchJson('/api/skills');
        state.skills = j.data || [];
        const sel = document.getElementById('skillSelect');
        sel.innerHTML = '<option value="">選択</option>' + state.skills.map(s=>`<option value="${s.id}">${s.name||s.code||('#'+s.id)}</option>`).join('');
      }catch{ state.skills = []; }
    }

    async function loadPairing(){
      try{ const r = await fetch('/api/config/pairing-settings'); state.pairing = await r.json(); }
      catch(e){ state.pairing=null; }
    }

    async function loadDay(dateStr){
      const r = await fetch(`/api/demand?date=${dateStr}`);
      const j = await r.json();
      state.days[dateStr] = j.data||[];
    }

    async function loadMonth(){
      renderCalendar();
    }

    function sumSeats(list){ return (list||[]).reduce((a,b)=> a + (b.requiredSeats||0), 0); }

    async function renderCalendar(){
      const grid = document.getElementById('grid'); grid.innerHTML='';
      const base = firstOfMonth(state.year, state.month);
      const start = startOfCalendar(base);
      const promises=[];
      for(let i=0;i<42;i++){
        const d = addDays(start, i); const ds = fmtDate(d);
        const cell = document.createElement('div');
        cell.id = `cell-${ds}`;
        cell.className = 'calendar-cell' + (d.getMonth()+1!==state.month? ' other':'' );
        cell.innerHTML = `<div class="date">${d.getDate()}</div><div class="sum" id="sum-${ds}">-</div>`;
        cell.addEventListener('click', ()=> selectDate(ds));
        grid.appendChild(cell);
        if (d.getMonth()+1===state.month){
          promises.push(loadDay(ds).then(()=>{
            document.getElementById(`sum-${ds}`).textContent = `合計 ${sumSeats(state.days[ds])}`;
          }));
        } else {
          document.getElementById(`sum-${ds}`).textContent = '';
        }
      }
      await Promise.all(promises);
      const today = new Date();
      const todayStr = fmtDate(today);
      const def = (today.getFullYear()===state.year && (today.getMonth()+1)===state.month) ? todayStr : fmtDate(base);
      selectDate(def);
    }

    function renderList(){
      const list = document.getElementById('list');
      const rows = state.days[state.selectedDate]||[];
      const total = sumSeats(rows);
      document.getElementById('panelSummary').textContent = `合計: ${total}`;
      let html = '<table><thead><tr><th>時間帯</th><th>座席</th><th>スキル</th><th></th></tr></thead><tbody>';
      for(const r of rows){
        const sk = r.skill ? (r.skill.name||r.skill.code||('#'+r.skill.id)) : '';
        html += `<tr data-id="${r.id}">
          <td>${(r.startTime||'').slice(0,5)} - ${(r.endTime||'').slice(0,5)}</td>
          <td>${r.requiredSeats}</td>
          <td>${sk}</td>
          <td class="actions">
            <button class="ghost btn-edit" data-id="${r.id}">編集</button>
            <button class="danger btn-del" data-id="${r.id}">削除</button>
          </td>
        </tr>`;
      }
      html += '</tbody></table>';
      list.innerHTML = html;
      list.querySelectorAll('.btn-del').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm(`需要ID=${id} を削除しますか?`)) return;
          const res = await fetch(`/api/demand/${id}`, { method:'DELETE' });
          if(!res.ok){ alert('削除に失敗しました'); return; }
          await loadDay(state.selectedDate); renderList();
          document.getElementById(`sum-${state.selectedDate}`).textContent = `合計 ${sumSeats(state.days[state.selectedDate])}`;
        });
      });
      list.querySelectorAll('.btn-edit').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(e.currentTarget.getAttribute('data-id'));
          const row = (state.days[state.selectedDate]||[]).find(x=>x.id===id);
          if(!row) return;
          document.getElementById('f_start').value = (row.startTime||'').slice(0,5);
          document.getElementById('f_end').value = (row.endTime||'').slice(0,5);
          document.getElementById('f_seats').value = row.requiredSeats;
          document.getElementById('skillSelect').value = row.skill ? String(row.skill.id) : '';
          document.getElementById('btnAdd').textContent = '更新';
          document.getElementById('btnAdd').dataset.editId = String(row.id);
        });
      });
    }

    async function selectDate(dateStr){
      state.selectedDate = dateStr;
      document.getElementById('panelDate').textContent = dateStr;
      document.querySelectorAll('.calendar-cell.selected').forEach(el=> el.classList.remove('selected'));
      const el = document.getElementById(`cell-${dateStr}`); if (el) el.classList.add('selected');
      if (!state.days[dateStr]){ await loadDay(dateStr); }
      renderList();
    }

    async function createOrUpdateByForm(win){
      const start = win?.s || document.getElementById('f_start').value;
      const end = win?.e || document.getElementById('f_end').value;
      const seats = Number(document.getElementById('f_seats').value||document.getElementById('defaultSeats').value||0);
      const skillIdStr = document.getElementById('skillSelect').value;
      const skillId = skillIdStr? Number(skillIdStr): null;
      if (!state.selectedDate){ alert('日付を選択してください'); return; }
      if (!skillId){ alert('スキルを選択してください'); return; }
      if (!start || !end || start>=end){ alert('時間帯を確認してください'); return; }
      if (seats<0){ alert('座席数は0以上にしてください'); return; }
      const editId = document.getElementById('btnAdd').dataset.editId;
      const body = { date: state.selectedDate, dayOfWeek: null, startTime: start, endTime: end, requiredSeats: seats, skillId, active: true };
      const url = editId ? `/api/demand/${editId}` : '/api/demand';
      const method = editId ? 'PUT' : 'POST';
      const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(!r.ok){
        try{ const j=await r.json(); alert(j.message||'保存に失敗しました'); }
        catch{ alert('保存に失敗しました'); }
        return;
      }
      document.getElementById('btnAdd').textContent = '追加';
      delete document.getElementById('btnAdd').dataset.editId;
      await loadDay(state.selectedDate); renderList();
      document.getElementById(`sum-${state.selectedDate}`).textContent = `合計 ${sumSeats(state.days[state.selectedDate])}`;
    }

    async function applyWeeklyTemplates() {
      if (!state.year || !state.month) return;
      setMonthlyMessage('曜日テンプレートを適用しています...', true);
      try {
        const res = await fetch('/api/demand/monthly/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year: state.year, month: state.month })
        });
        const j = await res.json().catch(()=>({}));
        if (!res.ok || j.success === false) throw new Error(j.message || '適用に失敗しました');
        setMonthlyMessage(j.message || '曜日テンプレートを適用しました', true);
        await loadMonth();
      } catch (e) {
        setMonthlyMessage(e.message || '適用に失敗しました', false);
      }
    }

    function bindEvents(){
      document.getElementById('btnAdd').addEventListener('click', ()=> createOrUpdateByForm());
      document.getElementById('btnAddAM').addEventListener('click', ()=>{
        const ps = state.pairing; if(!ps){ alert('ペア設定の取得に失敗しました'); return; }
        const {s,e} = parseWin(ps.morningWindow||'09:00-13:00');
        createOrUpdateByForm({s,e});
      });
      document.getElementById('btnAddPM').addEventListener('click', ()=>{
        const ps = state.pairing; if(!ps){ alert('ペア設定の取得に失敗しました'); return; }
        const {s,e} = parseWin(ps.afternoonWindow||'13:00-18:00');
        createOrUpdateByForm({s,e});
      });
      document.getElementById('btnAddFull').addEventListener('click', ()=>{
        const ps = state.pairing; if(!ps){ alert('ペア設定の取得に失敗しました'); return; }
        const {s,e} = parseWin(ps.fullWindow||'09:00-18:00');
        createOrUpdateByForm({s,e});
      });
      document.getElementById('skillSelect').addEventListener('change', ()=>{
        const dis = !document.getElementById('skillSelect').value;
        ['btnAddAM','btnAddPM','btnAddFull'].forEach(id=>{ const b=document.getElementById(id); if(b){ b.disabled = dis; }});
      });
      document.getElementById('btnGenerate').addEventListener('click', async ()=>{
        const y = state.year, m = state.month; if(!y||!m) return;
        if (!confirm(`${y}年${m}月を需要ベースで生成します。よろしいですか?`)) return;
        const url = `/api/schedule/generate/demand/async?year=${y}&month=${m}&granularity=60&reset=true`;
        try{
          const r=await fetch(url,{method:'POST'});
          const j=await r.json();
          alert(j.message||'生成リクエストを受け付けました');
        }catch{ alert('生成の開始に失敗しました'); }
      });
      document.getElementById('ym').addEventListener('change', ()=>{
        const v = document.getElementById('ym').value;
        if(!v) return;
        const y=Number(v.slice(0,4)), m=Number(v.slice(5));
        state.year=y; state.month=m; loadMonth();
      });
      document.getElementById('btnApplyWeekly').addEventListener('click', applyWeeklyTemplates);
    }

    document.getElementById('btn-view-effective').addEventListener('click', loadEffective);
    document.getElementById('btn-view-all').addEventListener('click', loadAll);
    document.getElementById('btn-view-sort').addEventListener('click', tidyOrder);
    document.getElementById('weekly-submit').addEventListener('click', submitWeekly);
    document.getElementById('weekly-cancel').addEventListener('click', resetWeeklyForm);

    document.addEventListener('DOMContentLoaded', async ()=>{
      const today = new Date();
      document.getElementById('view-date').value = today.toISOString().slice(0,10);
      const ym = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      document.getElementById('ym').value = ym;
      state.year = today.getFullYear();
      state.month = today.getMonth()+1;
      document.getElementById('f_seats').value = document.getElementById('defaultSeats').value;

      await Promise.all([loadWeeklySkills(), loadAll()]);
      await refreshWeeklyTable();
      resetWeeklyForm();

      await loadSkillsForMonthly();
      await loadPairing();
      await loadMonth();
      bindEvents();
      await loadEffective();
    });
  </script>
</body>
</html>
