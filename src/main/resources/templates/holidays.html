<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>祝日管理</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; margin:0; background:#f5f7fb; color:#0f172a; }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    label { font-size:14px; color:#475569; display:flex; flex-direction:column; gap:4px; }
    input, button { padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px; }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    button.ghost { background:#f1f5f9; color:#0f172a; }
    button.danger { background:#ef4444; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #e2e8f0; padding:8px; text-align:left; font-size:14px; }
    th { color:#475569; }
    .muted { color:#94a3b8; font-size:13px; margin-top:8px; }
    .message { font-size:14px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>祝日管理</h1>
    <section class="card">
      <div class="row">
        <label>日付<input type="date" id="holiday-date" /></label>
        <label>名称<input type="text" id="holiday-name" placeholder="例: 文化の日" /></label>
        <button id="holiday-save">登録 / 更新</button>
        <button id="holiday-cancel" class="ghost">キャンセル</button>
      </div>
      <div id="holiday-msg" class="message"></div>
      <table>
        <thead>
          <tr><th>ID</th><th>日付</th><th>名称</th><th></th></tr>
        </thead>
        <tbody id="holiday-table"></tbody>
      </table>
      <div class="muted">登録した祝日は曜日テンプレートで「祝」を選択した需要に利用されます。</div>
    </section>
  </div>

  <script>
    let holidayEditingId = null;

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, { credentials: 'include', headers: { 'Content-Type': 'application/json' }, ...options });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) {
        throw new Error(data.message || 'リクエストに失敗しました');
      }
      return data;
    }

    async function loadHolidays() {
      try {
        const res = await fetchJson('/api/holidays');
        renderHolidayTable(res.data || []);
      } catch (e) {
        document.getElementById('holiday-msg').textContent = e.message;
      }
    }

    function renderHolidayTable(list) {
      const tbody = document.getElementById('holiday-table');
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted">祝日は登録されていません</td></tr>';
        return;
      }
      tbody.innerHTML = list.map(h => `
        <tr>
          <td>${h.id}</td>
          <td>${h.date}</td>
          <td>${h.name || ''}</td>
          <td>
            <button class="ghost" data-act="edit" data-id="${h.id}">編集</button>
            <button class="danger" data-act="delete" data-id="${h.id}">削除</button>
          </td>
        </tr>`).join('');
      tbody.querySelectorAll('button[data-act="edit"]').forEach(btn => btn.addEventListener('click', () => startEdit(list.find(h => String(h.id) === btn.dataset.id))));
      tbody.querySelectorAll('button[data-act="delete"]').forEach(btn => btn.addEventListener('click', () => deleteHoliday(btn.dataset.id)));
    }

    async function saveHoliday() {
      const date = document.getElementById('holiday-date').value;
      const name = document.getElementById('holiday-name').value.trim();
      if (!date) {
        setMessage('日付を入力してください');
        return;
      }
      const payload = JSON.stringify({ date, name });
      try {
        if (holidayEditingId) {
          await fetchJson(`/api/holidays/${holidayEditingId}`, { method: 'PUT', body: payload });
          setMessage('祝日を更新しました', true);
        } else {
          await fetchJson('/api/holidays', { method: 'POST', body: payload });
          setMessage('祝日を登録しました', true);
        }
        resetForm();
        await loadHolidays();
      } catch (e) {
        setMessage(e.message);
      }
    }

    async function deleteHoliday(id) {
      if (!confirm(`ID=${id} を削除しますか?`)) return;
      try {
        await fetchJson(`/api/holidays/${id}`, { method: 'DELETE' });
        setMessage('祝日を削除しました', true);
        if (Number(id) === holidayEditingId) {
          resetForm();
        }
        await loadHolidays();
      } catch (e) {
        setMessage(e.message);
      }
    }

    function startEdit(holiday) {
      if (!holiday) return;
      holidayEditingId = holiday.id;
      document.getElementById('holiday-date').value = holiday.date || '';
      document.getElementById('holiday-name').value = holiday.name || '';
      setMessage(`ID=${holiday.id} を編集中です`, false);
    }

    function resetForm() {
      holidayEditingId = null;
      document.getElementById('holiday-date').value = '';
      document.getElementById('holiday-name').value = '';
      setMessage('', false);
    }

    function setMessage(text, success = false) {
      const el = document.getElementById('holiday-msg');
      el.textContent = text;
      el.style.color = success ? '#15803d' : '#b91c1c';
      if (!text) el.removeAttribute('style');
    }

    document.getElementById('holiday-save').addEventListener('click', saveHoliday);
    document.getElementById('holiday-cancel').addEventListener('click', resetForm);
    window.addEventListener('DOMContentLoaded', loadHolidays);
  </script>
</body>
</html>
