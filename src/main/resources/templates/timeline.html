<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>タイムラインビュー</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; margin: 0; background: #f5f7fb; color: #0f172a; }
        .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        .toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
        .card { background:#fff; border:1px solid #e2e8f0; border-radius: 12px; padding:16px; }
        .grid { display: grid; grid-template-columns: 120px 1fr; }
        .times { display:flex; flex-direction: column; gap:4px; font-size: 12px; color:#475569; }
        .rows { display:flex; flex-direction: column; gap:4px; }
        .slot { border-bottom: 1px dashed #e2e8f0; padding: 4px 8px; min-height: 22px; }
        .slot.badge { display:inline-block; background:#eef2ff; color:#3730a3; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px; }
        .row { display:flex; align-items:center; gap:8px; }
        input, select, button { padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1; }
        button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
        .header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 12px; }
        .muted { color:#64748b; font-size: 12px; }
        .short-badge { display:inline-block; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px; }
        .short-badge.ok { background:#e0f2fe; color:#075985; }
        .short-badge.warn { background:#fee2e2; color:#7f1d1d; }
    </style>
    <script>
        async function fetchWithTimeout(url, ms = 15000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), ms);
            try {
                const res = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                return res;
            } catch (e) {
                clearTimeout(id);
                throw e;
            }
        }

        function showError(msg){
            const rowsCol = document.getElementById('rows');
            const timesCol = document.getElementById('times');
            timesCol.innerHTML = '';
            rowsCol.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'muted';
            div.textContent = msg || '読み込みに失敗しました';
            rowsCol.appendChild(div);
        }

        async function loadGrid() {
            const date = document.getElementById('date').value;
            const gran = document.getElementById('gran').value;
            const skillSel = document.getElementById('skill');
            const skillId = skillSel ? skillSel.value : '';
            let json;
            try {
                let url = `/api/schedule/grid/day?date=${date}&granularity=${gran}`;
                if (skillId) url += `&skillId=${skillId}`;
                const res = await fetchWithTimeout(url, 15000);
                json = await res.json();
            } catch (e) {
                showError('タイムラインの読み込みに失敗しました。もう一度お試しください。');
                return;
            }
            const data = json.data || {};
            const slots = data.slots || [];
            const timesCol = document.getElementById('times');
            const rowsCol = document.getElementById('rows');
            timesCol.innerHTML = '';
            rowsCol.innerHTML = '';
            for (const s of slots) {
                const divTime = document.createElement('div');
                divTime.textContent = `${s.start}`;
                divTime.className = 'slot';
                timesCol.appendChild(divTime);

                const divRow = document.createElement('div');
                divRow.className = 'slot';
                const names = s.employees || [];
                const assigned = (s.assigned ?? names.length);
                const required = (s.required ?? 0);
                const shortage = (s.shortage ?? Math.max(0, required - assigned));
                const cntBadge = document.createElement('span');
                cntBadge.className = 'short-badge ' + (shortage>0 ? 'warn' : 'ok');
                cntBadge.textContent = `${assigned}/${required}`;
                divRow.appendChild(cntBadge);
                if (names.length === 0) {
                    const span = document.createElement('span');
                    span.className = 'muted';
                    span.textContent = '—';
                    divRow.appendChild(span);
                } else {
                    names.forEach(n => {
                        const badge = document.createElement('span');
                        badge.className = 'slot badge';
                        badge.textContent = n;
                        divRow.appendChild(badge);
                    });
                }
                rowsCol.appendChild(divRow);
            }
        }

        async function loadSkills(){
            try{
                const r = await fetch('/api/skills');
                const j = await r.json();
                const sel = document.getElementById('skill');
                const sel2 = document.getElementById('boostSkill');
                if (sel){ sel.innerHTML = '<option value="">すべて</option>' + (j.data||[]).map(s=>`<option value="${s.id}">${s.name||s.code||('#'+s.id)}</option>`).join(''); }
                if (sel2){ sel2.innerHTML = '<option value="">選択</option>' + (j.data||[]).map(s=>`<option value="${s.id}">${s.name||s.code||('#'+s.id)}</option>`).join(''); }
            }catch(e){}
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const today = new Date().toISOString().slice(0,10);
            document.getElementById('date').value = today;
            await loadSkills();
            loadGrid();
            const skillSel = document.getElementById('skill');
            if (skillSel){ skillSel.addEventListener('change', loadGrid); }
            const btn = document.getElementById('btnBoost');
            if (btn){ btn.addEventListener('click', applyBoost); }
        });

        async function applyBoost(){
            const date = document.getElementById('date').value;
            const start = document.getElementById('boostStart').value;
            const end = document.getElementById('boostEnd').value;
            const seats = parseInt(document.getElementById('boostSeats').value||'1',10) || 1;
            const skillId = document.getElementById('boostSkill').value;
            if (!start || !end || start>=end){ alert('時間帯が不正です'); return; }
            if (!skillId){ alert('スキルを選択してください'); return; }
            try{
                const body = { date, skillId: Number(skillId), skillCode: null, startTime: start, endTime: end, seats };
                const r = await fetch('/api/schedule/core-boost', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const j = await r.json();
                if (!r.ok || !j.success){ alert(j.message||'ブーストに失敗しました'); return; }
                const upd = j.data?.updated ?? j.meta?.updated;
                const reason = j.data?.reason ?? j.meta?.reason;
                alert(`延長適用: ${upd} / 理由: ${reason||'ok'}`);
                loadGrid();
            }catch(e){ alert('ブーストに失敗しました'); }
        }
    </script>
 </head>
 <body>
   <div class="container">
     <div class="header">
        <h2>タイムラインビュー</h2>
        <div class="muted">15分/1時間単位で勤務状況を表示</div>
     </div>
     <div class="toolbar card">
        <label>日付 <input type="date" id="date" onchange="loadGrid()" /></label>
        <label>粒度
            <select id="gran" onchange="loadGrid()">
                <option value="15">15分</option>
                <option value="60" selected>1時間</option>
            </select>
        </label>
        <label>スキル
            <select id="skill"><option value="">すべて</option></select>
        </label>
        <button onclick="loadGrid()">更新</button>
        <a href="/dashboard" style="margin-left:auto; text-decoration:none;">ダッシュボードへ</a>
     </div>
     <div class="card" style="margin-top:12px;">
        <div class="row" style="flex-wrap:wrap; gap:10px;">
            <strong>残業ブースト（当日需要の一時増強）</strong>
            <label>開始 <input type="time" id="boostStart" value="12:00" /></label>
            <label>終了 <input type="time" id="boostEnd" value="13:00" /></label>
            <label>座席 <input type="number" id="boostSeats" value="1" min="1" style="width:80px;" /></label>
            <label>スキル <select id="boostSkill"><option value="">選択</option></select></label>
            <button id="btnBoost">適用</button>
            <span class="muted">指定時間帯で既存担当者のシフトを可能な範囲で延長します</span>
        </div>
     </div>
     <div class="card">
        <div class="grid">
            <div id="times" class="times"></div>
            <div id="rows" class="rows"></div>
        </div>
     </div>
   </div>
 </body>
 </html>

