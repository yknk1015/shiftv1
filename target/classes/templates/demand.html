<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>需要（必要座席）管理</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; margin:0; background:#f5f7fb; color:#0f172a; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:16px; }
    h2 { margin: 0 0 12px; }
    label { display:block; margin:6px 0; font-size:14px; color:#475569; }
    input, select, button { padding:6px 10px; border-radius:8px; border:1px solid #cbd5e1; }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #e2e8f0; text-align:left; padding:8px; font-size:14px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>需要（必要座席）管理</h2>

    <div class="card">
      <div class="row">
        <label>日付 <input type="date" id="date" /></label>
        <button onclick="loadEffective()">当日の需要を表示</button>
        <button onclick="loadAll()">すべて表示</button>
      </div>
      <div id="effective" style="margin-top:12px"></div>
      <div id="all" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">需要の追加 / 編集</h3>
      <div class="row">
        <label>日付(任意) <input type="date" id="c_date" /></label>
        <label>曜日(任意)
          <select id="c_dow">
            <option value="">未指定</option>
            <option>MONDAY</option><option>TUESDAY</option><option>WEDNESDAY</option>
            <option>THURSDAY</option><option>FRIDAY</option><option>SATURDAY</option><option>SUNDAY</option>
          </select>
        </label>
        <label>開始 <input type="time" id="c_start" value="09:00" /></label>
        <label>終了 <input type="time" id="c_end" value="18:00" /></label>
        <label>必要数 <input type="number" id="c_req" value="5" min="0" /></label>
        <label>スキル(任意)
          <select id="c_skill_select">
            <option value="">未指定</option>
          </select>
        </label>
        <button id="c_submit" onclick="createOrUpdate()">追加</button>
        <button id="c_cancel" style="display:none;" onclick="cancelEdit()">キャンセル</button>
      </div>
      <div class="muted">日付/曜日のいずれかで適用。スキル未指定で全体の需要。</div>
      <div class="muted" style="margin-top:8px;">
        ヘルプ: 日付指定は曜日指定を上書き、スキル需要はグローバル需要より優先して割当されます。
      </div>
      <div id="create_msg" class="muted"></div>
    </div>

    <div class="muted"><a href="/dashboard">ダッシュボード</a> / <a href="/timeline">タイムライン</a></div>
  </div>

    <!-- 一括追加（曜日ベース） -->
    <div class="card">
      <h3 style="margin:0 0 8px;">曜日で一括追加</h3>
      <div class="row">
        <label>年 <input type="number" id="b_year" style="width:90px;" min="2000" max="2100" /></label>
        <label>月 <input type="number" id="b_month" style="width:70px;" min="1" max="12" /></label>
        <label>曜日
          <select id="b_dow">
            <option value="">未選択</option>
            <option>MONDAY</option><option>TUESDAY</option><option>WEDNESDAY</option>
            <option>THURSDAY</option><option>FRIDAY</option><option>SATURDAY</option><option>SUNDAY</option>
          </select>
        </label>
        <label>開始 <input type="time" id="b_start" value="09:00" /></label>
        <label>終了 <input type="time" id="b_end" value="18:00" /></label>
        <label>必要 <input type="number" id="b_req" value="5" min="0" /></label>
        <label>スキル
          <select id="b_skill_select">
            <option value="">未選択</option>
          </select>
        </label>
        <button id="b_submit" onclick="bulkAddByWeekday()">追加</button>
      </div>
      <div id="bulk_msg" class="muted"></div>
    </div>

  <script>
    let editingId = null;

    async function fetchWithTimeout(url, ms=15000, options={}){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), ms);
      try{
        const res = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return res;
      }catch(e){ clearTimeout(id); throw e; }
    }
    async function loadEffective(){
      const date = document.getElementById('date').value;
      if(!date){ alert('日付を選択してください'); return; }
      try{
        const res = await fetchWithTimeout(`/api/demand/effective?date=${date}`);
        const j = await res.json();
        renderTable('effective', '当日適用', j.data||[]);
      }catch(e){
        document.getElementById('effective').innerHTML = `<div class='muted'>読み込みに失敗しました</div>`;
      }
    }
    async function loadAll(){
      try{
        const res = await fetchWithTimeout(`/api/demand`);
        const j = await res.json();
        renderTable('all', 'すべて', j.data||[]);
      }catch(e){
        document.getElementById('all').innerHTML = `<div class='muted'>読み込みに失敗しました</div>`;
      }
    }
    function renderTable(id, title, rows){
      const el = document.getElementById(id);
      if(!rows.length){ el.innerHTML = `<h4>${title}</h4><div class='muted'>データなし</div>`; return; }
      let html = `<h4>${title}</h4><table><thead><tr><th style=\"display:none;\">ID</th><th></th><th>日付</th><th>曜日</th><th>時間</th><th>必要</th><th>スキル</th><th style="display:none;">並び順</th><th>操作</th></tr></thead><tbody>`;
      for(const r of rows){
        const id = r.id;
        const del = `<button data-id=\"${id}\" class=\"btn-del\" style=\"background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 8px;\">削除</button>`;
        const up = `<button data-id=\"${id}\" data-dir=\"up\" class=\"btn-move\" style=\"margin-left:6px;\">↑</button>`;
        const down = `<button data-id=\"${id}\" data-dir=\"down\" class=\"btn-move\" style=\"margin-left:4px;\">↓</button>`;
        const edit = `<button data-id=\"${id}\" class=\"btn-edit\" style=\"margin-left:6px;\">編集</button>`;
          html += `<tr data-id="${id}" data-order="${r.sortOrder||''}">`+
                  `<td style="display:none;" class="col-id">${id||''}</td>`+
                  `<td>${r.date||''}</td><td>${r.dayOfWeek||''}</td>`+
                  `<td>${r.startTime} - ${r.endTime}</td><td>${r.requiredSeats}</td>`+
                  `<td>${r.skill? (r.skill.name||r.skill.code||r.skill.id):''}</td>`+
                  `<td style="display:none;" class="col-order">${r.sortOrder??''}</td>`+
                  `<td>${del}${up}${down}${edit}</td></tr>`;
      }
      html += `</tbody></table>`;
      el.innerHTML = html;
      // enhance: add copy buttons and drag & drop reorder
      const tbodyEnh = el.querySelector('tbody');
      if (tbodyEnh) {
        tbodyEnh.querySelectorAll('tr').forEach(tr => {
          const idVal = Number(tr.getAttribute('data-id'));
          // add copy button
          const actionTd = tr.querySelector('td:last-child');
          if (actionTd && !actionTd.querySelector('.btn-copy')) {
            const btn = document.createElement('button');
            btn.className = 'btn-copy';
            btn.textContent = 'コピー';
            btn.style.marginLeft = '6px';
            btn.addEventListener('click', async () => {
              try{
                const res = await fetch(`/api/demand/${idVal}/copy`, { method:'POST', headers:{'Content-Type':'application/json'}, body: '{}' });
                if(!res.ok){ alert('コピーに失敗しました'); return; }
                if(document.getElementById('date').value){ await loadEffective(); }
                await loadAll();
              }catch(_){ alert('コピーに失敗しました'); }
            });
            actionTd.appendChild(btn);
          }
          // enable drag
          tr.setAttribute('draggable','true');
          tr.addEventListener('dragstart', (ev) => { tr.classList.add('dragging'); ev.dataTransfer.effectAllowed = 'move'; });
          tr.addEventListener('dragend', () => tr.classList.remove('dragging'));
        });
        tbodyEnh.addEventListener('dragover', (ev) => {
          ev.preventDefault();
          const dragging = tbodyEnh.querySelector('tr.dragging');
          const after = Array.from(tbodyEnh.querySelectorAll('tr:not(.dragging)')).find(row => {
            const rect = row.getBoundingClientRect();
            return ev.clientY <= rect.top + rect.height/2;
          });
          if (!dragging) return;
          if (after) tbodyEnh.insertBefore(dragging, after); else tbodyEnh.appendChild(dragging);
        });
        tbodyEnh.addEventListener('drop', async (ev) => {
          ev.preventDefault();
          const ids = Array.from(tbodyEnh.querySelectorAll('tr')).map(r=>Number(r.getAttribute('data-id')));
          try{
            const res = await fetch('/api/demand/reorder', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(ids)});
            if(!res.ok){ alert('並び替えの保存に失敗しました'); }
          }catch(_){ alert('並び替えの保存に失敗しました'); }
        });
      }
      // wire events
      el.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.getAttribute('data-id');
          if(!confirm(`ID=${id} を削除しますか？`)) return;
          const res = await fetch(`/api/demand/${id}`, { method:'DELETE' });
          if(!res.ok){ alert('削除に失敗しました'); return; }
          if(document.getElementById('date').value){ await loadEffective(); }
          await loadAll();
        });
      });
      el.querySelectorAll('.btn-move').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = Number(e.currentTarget.getAttribute('data-id'));
          const dir = e.currentTarget.getAttribute('data-dir');
          // find current list order
          const rowsArr = Array.from(el.querySelectorAll('tbody tr'));
          const idx = rowsArr.findIndex(tr => Number(tr.getAttribute('data-id')) === id);
          if (idx === -1) return;
          const swapIdx = dir === 'up' ? idx - 1 : idx + 1;
          if (swapIdx < 0 || swapIdx >= rowsArr.length) return; // no-op
          const otherId = Number(rowsArr[swapIdx].getAttribute('data-id'));
          const res = await fetch(`/api/demand/swap?a=${id}&b=${otherId}`, { method:'POST' });
          if(!res.ok){ alert('並び替えに失敗しました'); return; }
          if(document.getElementById('date').value){ await loadEffective(); }
          await loadAll();
        });
      });
      el.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = Number(e.currentTarget.getAttribute('data-id'));
          const row = rows.find(x => x.id === id);
          if(!row) return;
          startEdit(row);
        });
      });
    }
    function startEdit(r){
      editingId = r.id;
      document.getElementById('c_date').value = r.date || '';
      document.getElementById('c_dow').value = r.dayOfWeek || '';
      document.getElementById('c_start').value = (r.startTime||'').slice(0,5);
      document.getElementById('c_end').value = (r.endTime||'').slice(0,5);
      document.getElementById('c_req').value = r.requiredSeats;
      const sel = document.getElementById('c_skill_select');
      sel.value = r.skill ? String(r.skill.id) : '';
      document.getElementById('c_submit').textContent = '更新';
      document.getElementById('c_cancel').style.display = '';
      document.getElementById('create_msg').textContent = '編集モードです。更新後に「更新」を押してください。';
    }
    function cancelEdit(){
      editingId = null;
      document.getElementById('c_date').value = '';
      document.getElementById('c_dow').value = '';
      document.getElementById('c_start').value = '09:00';
      document.getElementById('c_end').value = '18:00';
      document.getElementById('c_req').value = 5;
      document.getElementById('c_skill_select').value = '';
      document.getElementById('c_submit').textContent = '追加';
      document.getElementById('c_cancel').style.display = 'none';
      document.getElementById('create_msg').textContent = '';
    }
    async function createOrUpdate(){
      const body = {
        date: document.getElementById('c_date').value || null,
        dayOfWeek: (document.getElementById('c_dow').value || null),
        startTime: document.getElementById('c_start').value,
        endTime: document.getElementById('c_end').value,
        requiredSeats: Number(document.getElementById('c_req').value),
        skillId: (document.getElementById('c_skill_select').value||'')? Number(document.getElementById('c_skill_select').value): null,
        active: true
      };
      let url = '/api/demand';
      let method = 'POST';
      if (editingId) { url = `/api/demand/${editingId}`; method = 'PUT'; }
      const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await res.json();
      document.getElementById('create_msg').textContent = j.message || (j.success? (editingId? '更新しました':'作成しました'):'失敗しました');
      if(j.success){ cancelEdit(); await loadAll(); if(document.getElementById('date').value){ await loadEffective(); } }
    }
    async function loadSkills(){
      try{
        const res = await fetch('/api/skills');
        const j = await res.json();
        const list = j.data || [];
        const sel = document.getElementById('c_skill_select');
        sel.innerHTML = '<option value="">未指定</option>' + list.map(s => `<option value="${s.id}">${s.name||s.code||s.id}</option>`).join('');
      }catch(e){ /* noop */ }
    }
    window.addEventListener('DOMContentLoaded', async ()=>{
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('date').value = today;
      await loadSkills();
      await loadAll();
    });
  </script>
  <script>
    async function bulkAddByWeekday(){
      const year = Number(document.getElementById('b_year')?.value);
      const month = Number(document.getElementById('b_month')?.value);
      const dayOfWeek = document.getElementById('b_dow')?.value;
      const startTime = document.getElementById('b_start')?.value;
      const endTime = document.getElementById('b_end')?.value;
      const requiredSeats = Number(document.getElementById('b_req')?.value);
      const sel = document.getElementById('b_skill_select');
      const skillId = (sel && sel.value)? Number(sel.value): null;
      const msg = document.getElementById('bulk_msg');
      if (msg) msg.textContent = '';
      if(!year || !month || !dayOfWeek || !startTime || !endTime || !skillId){ if(msg) msg.textContent = '年/月/曜日/時間/スキルは必須です'; return; }
      try{
        const res = await fetch('/api/demand/bulk/by-weekday', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ year, month, dayOfWeek, startTime, endTime, requiredSeats, skillId }) });
        const j = await res.json();
        if(msg) msg.textContent = j.message || '一括追加を実行しました';
        await loadAll(); if(document.getElementById('date').value){ await loadEffective(); }
      }catch(e){ if(msg) msg.textContent = '一括追加に失敗しました'; }
    }
    document.addEventListener('DOMContentLoaded', async () => {
      const by = document.getElementById('b_year');
      const bm = document.getElementById('b_month');
      const bs = document.getElementById('b_skill_select');
      try{
        const d = new Date();
        if (by) by.value = d.getFullYear();
        if (bm) bm.value = d.getMonth()+1;
        if (bs) {
          const res = await fetch('/api/skills');
          const j = await res.json();
          const list = j.data || [];
          bs.innerHTML = '<option value="">未選択</option>' + list.map(s => `<option value="${s.id}">${s.name||s.code||s.id}</option>`).join('');
        }
      }catch(_){ /* noop */ }
    });
  </script>
</body>
</html>
