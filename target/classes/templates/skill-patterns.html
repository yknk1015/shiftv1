<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>スキル別勤務パターン</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif; margin:0; background:#f5f7fb; color:#0f172a; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    input, select, button { padding:8px 10px; border-radius:8px; border:1px solid #cbd5e1; font-size:14px; }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #e2e8f0; text-align:left; }
    .muted { color:#64748b; font-size:12px; }
    .link { color:#2563eb; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>スキル別勤務パターン</h2>

    <div class="card">
      <div class="row">
        <label>スキル<br><select id="skill"></select></label>
        <label>曜日（任意）<br>
          <select id="dow">
            <option value="">（指定なし）</option>
            <option>MONDAY</option><option>TUESDAY</option><option>WEDNESDAY</option>
            <option>THURSDAY</option><option>FRIDAY</option><option>SATURDAY</option><option>SUNDAY</option>
          </select>
        </label>
        <label>開始（任意）<br><input type="time" id="st" /></label>
        <label>終了（任意）<br><input type="time" id="et" /></label>
        <label>許可長さ（CSV）<br><input type="text" id="lens" value="6,4" /></label>
        <label>優先ヒント<br>
          <select id="hint">
            <option>ANY</option><option>FIRST</option><option>LAST</option><option>MIDDLE</option>
          </select>
        </label>
        <label><input type="checkbox" id="active" checked/> 有効</label>
        <button id="create">登録</button>
        <label style="margin-left:auto;">表示対象<br>
          <select id="filter-active">
            <option value="true">有効のみ</option>
            <option value="false">全て</option>
          </select>
        </label>
        <button id="reload">再読込</button>
      </div>
      <div id="msg" class="muted" style="margin-top:6px;"></div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr><th>ID</th><th>スキル</th><th>曜日</th><th>開始</th><th>終了</th><th>許可長さ</th><th>ヒント</th><th>有効</th><th>操作</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="muted"><a class="link" href="/admin-actions">管理メニュー</a> / <a class="link" href="/skill-management">スキル管理</a></div>
  </div>
  <script>
    function msg(t){ const el=document.getElementById('msg'); if(el) el.textContent=t||''; }
    async function api(url,opt={}){
      const res=await fetch(url,{credentials:'include', headers:{'Content-Type':'application/json'}, ...opt});
      const ct=res.headers.get('content-type')||''; const data=ct.includes('json')?await res.json():await res.text();
      if(!res.ok) throw new Error((data&&data.message)||('HTTP '+res.status));
      if(data && data.success===false) throw new Error(data.message||'処理に失敗しました');
      return data;
    }
    async function loadSkills(){
      const j = await api('/api/skills'); const list=j.data||[];
      const sel=document.getElementById('skill'); sel.innerHTML=list.map(s=>`<option value="${s.id}">${s.code||''} ${s.name||''}</option>`).join('');
    }
    function trRow(p, skills){
      const tr=document.createElement('tr');
      const sk = p.skill ? (p.skill.code||'')+' '+(p.skill.name||'') : '';
      tr.innerHTML = `<td>${p.id}</td>
        <td>${sk}</td>
        <td><input value="${p.dayOfWeek||''}" placeholder="MONDAY 等/空で全" style="width:110px"/></td>
        <td><input type="time" value="${(p.startTime||'').substring(0,5)}"/></td>
        <td><input type="time" value="${(p.endTime||'').substring(0,5)}"/></td>
        <td><input value="${p.allowedLengthsCsv||''}" style="width:90px"/></td>
        <td>
          <select>
            ${['ANY','FIRST','LAST','MIDDLE'].map(h=>`<option ${p.priorityHint===h?'selected':''}>${h}</option>`).join('')}
          </select>
        </td>
        <td><input type="checkbox" ${p.active?'checked':''}/></td>
        <td>
          <button data-a="save">保存</button>
          <button data-a="del" style="background:#ef4444;">削除</button>
        </td>`;
      const inputs=tr.querySelectorAll('input,select');
      tr.querySelector('[data-a="save"]').addEventListener('click', async()=>{
        const body={
          dayOfWeek: inputs[1].value.trim(),
          startTime: inputs[2].value||'',
          endTime: inputs[3].value||'',
          allowedLengthsCsv: inputs[4].value.trim(),
          priorityHint: inputs[5].value,
          active: inputs[6].checked
        };
        try{ const r=await api(`/api/skill-patterns/${p.id}`,{method:'PUT',body:JSON.stringify(body)}); msg(r.message||'更新しました'); await reload(); }catch(e){ msg(e.message||'更新に失敗しました'); }
      });
      tr.querySelector('[data-a="del"]').addEventListener('click', async()=>{
        if(!confirm('削除しますか？')) return; try{ const r=await api(`/api/skill-patterns/${p.id}`,{method:'DELETE'}); msg(r.message||'削除しました'); await reload(); }catch(e){ msg(e.message||'削除に失敗しました'); }
      });
      return tr;
    }
    async function reload(){
      const activeOnly=document.getElementById('filter-active').value==='true';
      const skillId=document.getElementById('skill').value;
      const url = '/api/skill-patterns?activeOnly='+activeOnly+'&skillId='+encodeURIComponent(skillId);
      try{ const j=await api(url); const list=j.data||[]; const tb=document.getElementById('tbody'); tb.innerHTML=''; list.forEach(p=>tb.appendChild(trRow(p))); msg(`件数: ${list.length}`);}catch(e){ msg(e.message||'取得に失敗しました'); }
    }
    async function create(){
      const skillId=Number(document.getElementById('skill').value);
      const dayOfWeek=document.getElementById('dow').value;
      const startTime=document.getElementById('st').value;
      const endTime=document.getElementById('et').value;
      const allowedLengthsCsv=document.getElementById('lens').value.trim();
      const priorityHint=document.getElementById('hint').value;
      const active=document.getElementById('active').checked;
      try{ const r=await api('/api/skill-patterns',{method:'POST', body: JSON.stringify({skillId, dayOfWeek, startTime, endTime, allowedLengthsCsv, priorityHint, active})}); msg(r.message||'登録しました'); await reload(); }catch(e){ msg(e.message||'登録に失敗しました'); }
    }
    document.getElementById('create').addEventListener('click', create);
    document.getElementById('reload').addEventListener('click', reload);
    window.addEventListener('DOMContentLoaded', async()=>{ await loadSkills(); await reload(); });
  </script>
</body>
</html>

